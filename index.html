<!DOCTYPE html>
<html lang="ro">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificare IMM PTJ</title>
    <!-- React and Babel via CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700&family=JetBrains+Mono:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <!-- SheetJS for Excel Download -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- docx.js for DOCX generation -->
    <script src="https://unpkg.com/docx@9.5.1/dist/index.iife.js"></script>
    <!-- Excel template data -->
    <script src="template_data.js"></script>
    <!-- PDF.js for PDF Import -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    </script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: "#0B1120",
                        card: "#111827",
                        cardAlt: "#1A2332",
                        border: "#1E293B",
                        accent: "#F59E0B",
                        accentDim: "rgba(245,158,11,0.12)",
                        accentBorder: "rgba(245,158,11,0.3)",
                        greenCustom: "#10B981",
                        greenDim: "rgba(16,185,129,0.12)",
                        greenBorder: "rgba(16,185,129,0.3)",
                        redCustom: "#EF4444",
                        redDim: "rgba(239,68,68,0.12)",
                        redBorder: "rgba(239,68,68,0.3)",
                        blueCustom: "#3B82F6",
                        blueDim: "rgba(59,130,246,0.12)",
                        blueBorder: "rgba(59,130,246,0.3)",
                        purpleCustom: "#8B5CF6",
                        purpleDim: "rgba(139,92,246,0.12)",
                        purpleBorder: "rgba(139,92,246,0.3)",
                        text: "#F1F5F9",
                        textDim: "#94A3B8",
                        textMuted: "#64748B",
                    },
                    fontFamily: {
                        sans: ['DM Sans', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style type="text/css">
        body {
            background-color: #0B1120;
            color: #F1F5F9;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #0B1120;
        }

        ::-webkit-scrollbar-thumb {
            background: #1E293B;
            border-radius: 3px;
        }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
        }

        .glass {
            background: rgba(17, 24, 39, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(30, 41, 59, 0.5);
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useCallback, useMemo, useEffect } = React;

        // ═══════════════════════════════════════════════════════════
        // ─── AUTH SYSTEM ───
        // ═══════════════════════════════════════════════════════════

        // Simple encode/decode for passwords (base64 obfuscation)
        const _enc = (s) => btoa(unescape(encodeURIComponent(s)));
        const _dec = (s) => { try { return decodeURIComponent(escape(atob(s))); } catch(e) { return ''; } };

        // Default admin account
        const DEFAULT_USERS = [
            { id: 1, username: "adrian.mariciuc", password: _enc("M@ra2@23"), role: "admin" }
        ];

        // Load users from localStorage or use defaults
        function loadUsers() {
            try {
                const stored = localStorage.getItem("imm_users");
                if (stored) {
                    const parsed = JSON.parse(stored);
                    if (Array.isArray(parsed) && parsed.length > 0) return parsed;
                }
            } catch (e) {}
            return DEFAULT_USERS;
        }

        function saveUsers(users) {
            localStorage.setItem("imm_users", JSON.stringify(users));
        }

        // Auth hook
        function useAuth() {
            const [currentUser, setCurrentUser] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                try {
                    const session = localStorage.getItem("imm_session");
                    if (session) {
                        const parsed = JSON.parse(session);
                        const users = loadUsers();
                        const user = users.find(u => u.id === parsed.id && u.username === parsed.username);
                        if (user) setCurrentUser(user);
                    }
                } catch (e) {}
                setLoading(false);
            }, []);

            const login = async (username, password) => {
                const users = loadUsers();
                const user = users.find(u => u.username.toLowerCase() === username.toLowerCase() && _dec(u.password) === password);
                if (!user) throw new Error("Utilizator sau parolă incorectă.");
                setCurrentUser(user);
                localStorage.setItem("imm_session", JSON.stringify({ id: user.id, username: user.username }));
                return user;
            };

            const logout = () => {
                setCurrentUser(null);
                localStorage.removeItem("imm_session");
            };

            return { currentUser, loading, login, logout };
        }

        // ─── Login Screen ───
        function LoginScreen({ onLogin }) {
            const [username, setUsername] = useState("");
            const [password, setPassword] = useState("");
            const [error, setError] = useState("");
            const [isLoading, setIsLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError("");
                setIsLoading(true);
                try {
                    await onLogin(username, password);
                } catch (err) {
                    setError(err.message);
                }
                setIsLoading(false);
            };

            return (
                <div className="min-h-screen bg-bg flex items-center justify-center p-4">
                    <div className="w-full max-w-sm">
                        <div className="text-center mb-8">
                            <div className="inline-flex items-center gap-3 mb-4">
                                <div className="p-3 rounded-xl bg-gradient-to-br from-accent to-orange-600 shadow-lg shadow-accent/20">
                                    <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>
                                </div>
                            </div>
                            <h1 className="text-2xl font-bold text-white tracking-tight">
                                Verificare IMM <span className="text-accent">PTJ</span>
                            </h1>
                            <p className="text-sm text-textDim mt-2">Autentificați-vă pentru a continua</p>
                        </div>
                        <div className="bg-card rounded-2xl border border-border p-6 shadow-xl">
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div>
                                    <label className="text-xs text-textDim uppercase mb-1.5 block font-medium tracking-wider">Utilizator</label>
                                    <input type="text" value={username} onChange={e => setUsername(e.target.value)}
                                        className="bg-cardAlt border border-border rounded-lg text-text px-3.5 py-2.5 text-sm w-full outline-none focus:border-accent transition-colors"
                                        placeholder="username" autoFocus required />
                                </div>
                                <div>
                                    <label className="text-xs text-textDim uppercase mb-1.5 block font-medium tracking-wider">Parolă</label>
                                    <input type="password" value={password} onChange={e => setPassword(e.target.value)}
                                        className="bg-cardAlt border border-border rounded-lg text-text px-3.5 py-2.5 text-sm w-full outline-none focus:border-accent transition-colors"
                                        placeholder="••••••••" required />
                                </div>
                                {error && (
                                    <div className="bg-redDim border border-redBorder rounded-lg px-3 py-2 text-xs text-redCustom flex items-center gap-2">
                                        <svg className="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                        {error}
                                    </div>
                                )}
                                <button type="submit" disabled={isLoading}
                                    className="w-full px-8 py-2.5 bg-accent text-bg font-bold rounded-lg hover:opacity-90 transition-opacity disabled:opacity-50 mt-2">
                                    {isLoading ? "Se autentifică..." : "Autentificare"}
                                </button>
                            </form>
                        </div>
                        <p className="text-center text-textMuted text-xs mt-6">Contactați administratorul pentru a obține acces.</p>
                    </div>
                </div>
            );
        }

        // ─── Admin Panel ───
        function AdminPanel({ currentUser, onClose }) {
            const [users, setUsers] = useState(loadUsers());
            const [newUsername, setNewUsername] = useState("");
            const [newPassword, setNewPassword] = useState("");
            const [newRole, setNewRole] = useState("user");
            const [msg, setMsg] = useState("");
            const [msgType, setMsgType] = useState("success");

            const showMsg = (text, type = "success") => {
                setMsg(text);
                setMsgType(type);
                setTimeout(() => setMsg(""), 3000);
            };

            const addUser = async (e) => {
                e.preventDefault();
                if (!newUsername.trim() || !newPassword.trim()) {
                    showMsg("Completați toate câmpurile.", "error");
                    return;
                }
                if (newPassword.length < 4) {
                    showMsg("Parola trebuie să aibă minim 4 caractere.", "error");
                    return;
                }
                if (users.find(u => u.username.toLowerCase() === newUsername.toLowerCase())) {
                    showMsg("Acest username există deja.", "error");
                    return;
                }
                const newUser = {
                    id: Date.now(),
                    username: newUsername.trim(),
                    password: _enc(newPassword),
                    role: newRole,
                };
                const updated = [...users, newUser];
                setUsers(updated);
                saveUsers(updated);
                setNewUsername("");
                setNewPassword("");
                showMsg(`Utilizatorul "${newUser.username}" a fost adăugat.`);
            };

            const removeUser = (userId) => {
                if (userId === currentUser.id) {
                    showMsg("Nu vă puteți șterge propriul cont.", "error");
                    return;
                }
                const user = users.find(u => u.id === userId);
                const updated = users.filter(u => u.id !== userId);
                setUsers(updated);
                saveUsers(updated);
                showMsg(`"${user.username}" a fost eliminat.`);
            };

            const toggleRole = (userId) => {
                if (userId === currentUser.id) {
                    showMsg("Nu vă puteți schimba propriul rol.", "error");
                    return;
                }
                const updated = users.map(u => u.id === userId ? { ...u, role: u.role === "admin" ? "user" : "admin" } : u);
                setUsers(updated);
                saveUsers(updated);
            };

            const changePassword = async (userId) => {
                const newPwd = prompt("Introduceți noua parolă (minim 4 caractere):");
                if (!newPwd || newPwd.length < 4) {
                    if (newPwd !== null) showMsg("Parola trebuie să aibă minim 4 caractere.", "error");
                    return;
                }
                const updated = users.map(u => u.id === userId ? { ...u, password: _enc(newPwd) } : u);
                setUsers(updated);
                saveUsers(updated);
                showMsg("Parola a fost schimbată.");
            };

            return (
                <div className="min-h-screen bg-bg text-text p-4 md:p-8">
                    <div className="max-w-3xl mx-auto">
                        <div className="flex items-center justify-between mb-8">
                            <h2 className="text-xl font-bold">
                                <span className="text-accent">Panou Admin</span> <span className="text-textDim font-normal">— Gestionare utilizatori</span>
                            </h2>
                            <button onClick={onClose}
                                className="px-4 py-2 bg-cardAlt border border-border rounded-lg text-sm text-textDim hover:text-text transition-colors">
                                ← Înapoi la aplicație
                            </button>
                        </div>

                        {/* Add User Form */}
                        <div className="bg-card rounded-2xl border border-border p-6 shadow-xl mb-6">
                            <h3 className="font-bold text-sm uppercase tracking-wider text-accent/80 mb-4">Adaugă utilizator nou</h3>
                            <form onSubmit={addUser} className="flex gap-3 flex-wrap items-end">
                                <div className="flex-1 min-w-[140px]">
                                    <label className="text-xs text-textDim uppercase mb-1 block font-medium tracking-wider">Username</label>
                                    <input type="text" value={newUsername} onChange={e => setNewUsername(e.target.value)}
                                        className="bg-cardAlt border border-border rounded-lg text-text px-3.5 py-2.5 text-sm w-full outline-none focus:border-accent transition-colors"
                                        placeholder="utilizator_nou" />
                                </div>
                                <div className="flex-1 min-w-[140px]">
                                    <label className="text-xs text-textDim uppercase mb-1 block font-medium tracking-wider">Parolă</label>
                                    <input type="text" value={newPassword} onChange={e => setNewPassword(e.target.value)}
                                        className="bg-cardAlt border border-border rounded-lg text-text px-3.5 py-2.5 text-sm w-full outline-none focus:border-accent transition-colors"
                                        placeholder="minim 4 caractere" />
                                </div>
                                <div className="min-w-[140px]">
                                    <label className="text-xs text-textDim uppercase mb-1 block font-medium tracking-wider">Rol</label>
                                    <select value={newRole} onChange={e => setNewRole(e.target.value)}
                                        className="bg-cardAlt border border-border rounded-lg text-text px-3.5 py-2.5 text-sm w-full outline-none focus:border-accent transition-colors">
                                        <option value="user">Utilizator</option>
                                        <option value="admin">Administrator</option>
                                    </select>
                                </div>
                                <button type="submit" className="px-6 py-2.5 bg-accent text-bg font-bold rounded-lg hover:opacity-90 transition-opacity">
                                    + Adaugă
                                </button>
                            </form>
                            {msg && (
                                <div className={`mt-3 text-xs rounded-lg px-3 py-2 ${msgType === 'error' ? 'bg-redDim border border-redBorder text-redCustom' : 'bg-greenDim border border-greenBorder text-greenCustom'}`}>
                                    {msg}
                                </div>
                            )}
                        </div>

                        {/* User List */}
                        <div className="bg-card rounded-2xl border border-border p-6 shadow-xl">
                            <h3 className="font-bold text-sm uppercase tracking-wider text-blueCustom/80 mb-4">
                                Utilizatori înregistrați ({users.length})
                            </h3>
                            <div className="space-y-2">
                                {users.map(u => (
                                    <div key={u.id} className="flex items-center justify-between bg-cardAlt rounded-xl border border-border p-3">
                                        <div className="flex items-center gap-3">
                                            <div className={`w-9 h-9 rounded-full flex items-center justify-center text-xs font-bold ${u.role === 'admin' ? 'bg-accentDim text-accent' : 'bg-blueDim text-blueCustom'}`}>
                                                {u.role === 'admin' ? 'A' : 'U'}
                                            </div>
                                            <div>
                                                <div className="text-sm font-medium">{u.username}</div>
                                                <div className="text-xs mt-0.5">
                                                    <span className={`inline-block px-2 py-0.5 rounded-full text-[10px] font-bold uppercase tracking-wider ${u.role === 'admin' ? 'bg-accentDim text-accent border border-accentBorder' : 'bg-blueDim text-blueCustom border border-blueBorder'}`}>
                                                        {u.role === 'admin' ? 'Administrator' : 'Utilizator'}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="flex gap-2 flex-wrap justify-end">
                                            <button onClick={() => changePassword(u.id)}
                                                className="px-3 py-1.5 text-xs bg-cardAlt border border-border rounded-lg text-textDim hover:text-text transition-colors">
                                                Schimbă parola
                                            </button>
                                            <button onClick={() => toggleRole(u.id)}
                                                className="px-3 py-1.5 text-xs bg-blueDim border border-blueBorder rounded-lg text-blueCustom hover:bg-blue-600/20 transition-colors">
                                                {u.role === 'admin' ? 'Fă utilizator' : 'Fă admin'}
                                            </button>
                                            {u.id !== currentUser.id && (
                                                <button onClick={() => removeUser(u.id)}
                                                    className="px-3 py-1.5 text-xs bg-redDim border border-redBorder rounded-lg text-redCustom hover:bg-red-600/20 transition-colors">
                                                    Elimină
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="mt-6 p-4 bg-cardAlt rounded-xl border border-border">
                            <p className="text-xs text-textMuted">
                                <span className="text-accent font-bold">Notă:</span> Utilizatorii sunt salvați local în browser (localStorage).
                                Fiecare browser/dispozitiv are propria listă de utilizatori.
                            </p>
                        </div>
                    </div>
                </div>
            );
        }

        // ═══════════════════════════════════════════════════════════
        // ─── END AUTH SYSTEM ───
        // ═══════════════════════════════════════════════════════════

        const EUR_RON = 4.97;

        // ─── Helpers ───
        const fmt = (n) => n?.toLocaleString("ro-RO", { maximumFractionDigits: 2 }) ?? "—";
        const fmtEur = (n) => n != null ? `€${fmt(n)}` : "—";
        const fmtRon = (n) => n != null ? `${fmt(n)} RON` : "—";

        // ─── Icons ───
        const IconBuilding = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18z" /><path d="M6 12H4a2 2 0 0 0-2 2v8h4" /><path d="M18 9h2a2 2 0 0 1 2 2v11h-4" /><path d="M10 6h4" /><path d="M10 10h4" /><path d="M10 14h4" /><path d="M10 18h4" /></svg>;
        const IconLink = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" /><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" /></svg>;
        const IconCheck = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#10B981" strokeWidth="2.5"><path d="M20 6 9 17l-5-5" /></svg>;
        const IconX = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#EF4444" strokeWidth="2.5"><path d="M18 6 6 18" /><path d="m6 6 12 12" /></svg>;
        const IconAlert = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#F59E0B" strokeWidth="2"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3" /><path d="M12 9v4" /><circle cx="12" cy="17" r="1" /></svg>;
        const IconPlus = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 5v14" /><path d="M5 12h14" /></svg>;
        const IconTrash = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /></svg>;

        // ─── Reusable Components ───
        function Card({ children, className = "", glow }) {
            return (
                <div className={`bg-card rounded-xl border border-border p-6 ${className}`}
                    style={glow ? { boxShadow: `0 0 20px ${glow}`, borderColor: glow } : {}}>
                    {children}
                </div>
            );
        }

        function Badge({ color, children }) {
            const colors = {
                green: "bg-greenDim text-greenCustom border-greenBorder",
                red: "bg-redDim text-redCustom border-redBorder",
                accent: "bg-accentDim text-accent border-accentBorder",
                blue: "bg-blueDim text-blueCustom border-blueBorder",
                purple: "bg-purpleDim text-purpleCustom border-purpleBorder",
            };
            return (
                <span className={`inline-flex items-center gap-1 border rounded-md px-2.5 py-1 text-xs font-semibold tracking-wide ${colors[color] || colors.blue}`}>
                    {children}
                </span>
            );
        }

        function NumberInput({ label, value, onChange, suffix, placeholder }) {
            return (
                <div className="flex-1 min-w-[160px]">
                    <span className="text-xs text-textDim uppercase mb-1 block font-medium tracking-wider">{label}</span>
                    <div className="relative">
                        <input type="number" step="any" value={value ?? ""} placeholder={placeholder || "0"}
                            onChange={e => onChange(e.target.value === "" ? null : parseFloat(e.target.value))}
                            className="bg-cardAlt border border-border rounded-lg text-text px-3.5 py-2.5 text-sm w-full outline-none focus:border-accent transition-colors font-mono"
                        />
                        {suffix && <span className="absolute right-3 top-1/2 -translate-y-1/2 text-textMuted text-xs pointer-events-none">{suffix}</span>}
                    </div>
                </div>
            );
        }

        function SelectInput({ label, value, onChange, options }) {
            return (
                <div className="flex-1 min-w-[160px]">
                    <span className="text-xs text-textDim uppercase mb-1 block font-medium tracking-wider">{label}</span>
                    <select value={value} onChange={e => onChange(e.target.value)}
                        className="bg-cardAlt border border-border rounded-lg text-text px-3.5 py-2.5 text-sm w-full outline-none cursor-pointer appearance-none focus:border-accent transition-colors"
                        style={{ backgroundImage: `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2394A3B8' stroke-width='2'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E")`, backgroundRepeat: "no-repeat", backgroundPosition: "right 12px center" }}>
                        {options.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
                    </select>
                </div>
            );
        }

        function TextInput({ label, value, onChange, placeholder }) {
            return (
                <div className="flex-1 min-w-[200px]">
                    <span className="text-xs text-textDim uppercase mb-1 block font-medium tracking-wider">{label}</span>
                    <input type="text" value={value} placeholder={placeholder}
                        onChange={e => onChange(e.target.value)}
                        className="bg-cardAlt border border-border rounded-lg text-text px-3.5 py-2.5 text-sm w-full outline-none focus:border-accent transition-colors"
                    />
                </div>
            );
        }

        function DaNuToggle({ label, value, onChange, observation, onObservationChange }) {
            return (
                <div className="py-3 border-b border-border/30 last:border-b-0">
                    <div className="flex flex-wrap items-start gap-3">
                        <span className="flex-1 text-xs text-text min-w-[200px] leading-relaxed pt-0.5">{label}</span>
                        <div className="flex gap-1">
                            <button onClick={() => onChange("DA")}
                                className={`px-3 py-1.5 text-xs font-bold rounded-md transition-all ${value === "DA" ? 'bg-greenDim text-greenCustom border border-greenBorder' : 'bg-cardAlt text-textMuted border border-border hover:border-greenBorder/50'}`}>
                                DA
                            </button>
                            <button onClick={() => onChange("NU")}
                                className={`px-3 py-1.5 text-xs font-bold rounded-md transition-all ${value === "NU" ? 'bg-redDim text-redCustom border border-redBorder' : 'bg-cardAlt text-textMuted border border-border hover:border-redBorder/50'}`}>
                                NU
                            </button>
                        </div>
                    </div>
                    {onObservationChange && (
                        <input type="text" placeholder="Observatii..." value={observation || ""}
                            onChange={e => onObservationChange(e.target.value)}
                            className="mt-2 bg-cardAlt border border-border rounded-lg text-text px-2.5 py-1.5 text-xs w-full outline-none focus:border-accent transition-colors" />
                    )}
                </div>
            );
        }

        function CollapsibleSection({ title, icon, isOpen, onToggle, children }) {
            return (
                <div className="border border-border/50 rounded-xl overflow-hidden mb-3">
                    <button onClick={onToggle}
                        className="w-full flex items-center justify-between px-4 py-3 bg-cardAlt/50 hover:bg-cardAlt transition-colors">
                        <div className="flex items-center gap-2">
                            <span className="text-sm">{icon}</span>
                            <span className="text-xs font-bold uppercase tracking-wider text-textDim">{title}</span>
                        </div>
                        <svg className={`w-4 h-4 text-textMuted transition-transform ${isOpen ? 'rotate-180' : ''}`}
                            fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="m6 9 6 6 6-6" /></svg>
                    </button>
                    {isOpen && <div className="px-4 py-3">{children}</div>}
                </div>
            );
        }

        function StepIndicator({ steps, current, onNavigate }) {
            return (
                <div className="flex gap-0.5 mb-8">
                    {steps.map((s, i) => {
                        const active = i === current;
                        const done = i < current;
                        return (
                            <button key={i} onClick={() => onNavigate(i)} className={`flex-1 p-3 transition-all flex items-center gap-2 justify-center border
                                ${active ? 'bg-accentDim border-accentBorder' : done ? 'bg-greenDim border-greenBorder' : 'bg-cardAlt border-border'}
                                ${i === 0 ? 'rounded-l-xl' : i === steps.length - 1 ? 'rounded-r-xl' : ''}`}>
                                <span className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold
                                    ${active ? 'bg-accent text-bg' : done ? 'bg-greenCustom text-bg' : 'bg-border text-textMuted'}`}>
                                    {done ? "✓" : i + 1}
                                </span>
                                <span className={`text-xs font-semibold whitespace-nowrap overflow-hidden text-ellipsis
                                    ${active ? 'text-accent' : done ? 'text-greenCustom' : 'text-textMuted'}`}>
                                    {s}
                                </span>
                            </button>
                        );
                    })}
                </div>
            );
        }

        function EnterpriseRow({ ent, onChange, onRemove, onFetchANAF, anafLoading, showRemove, index }) {
            const letter = String.fromCharCode(66 + index); // 0 -> B, 1 -> C...
            return (
                <div className="bg-cardAlt rounded-xl border border-border p-5 mb-4 relative">
                    {showRemove && (
                        <button onClick={onRemove} className="absolute top-3 right-3 bg-redDim border border-redBorder rounded-md w-7 h-7 flex items-center justify-center text-redCustom transition-opacity hover:opacity-80">
                            <IconTrash />
                        </button>
                    )}
                    <div className="flex items-center justify-between mb-4">
                        <div className="flex items-center gap-2 text-blueCustom font-bold uppercase tracking-widest text-[10px]">
                            <div className="w-5 h-5 rounded bg-blueCustom text-bg flex items-center justify-center text-[10px]">{letter}</div>
                            Date financiare {letter}
                        </div>
                        <div className="flex items-center gap-2">
                            <button onClick={() => onFetchANAF(ent.id, ent.cui)} disabled={anafLoading}
                                className="flex items-center gap-1.5 px-3 py-1 bg-accentDim text-accent text-[10px] font-bold rounded-md hover:bg-accent/20 transition-colors border border-accentBorder/30 disabled:opacity-50">
                                {anafLoading ? (
                                    <><div className="w-3 h-3 border-2 border-accent border-t-transparent rounded-full animate-spin"></div> Se preia...</>
                                ) : (
                                    <><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg> Import ANAF</>
                                )}
                            </button>
                            <label className="flex items-center gap-1.5 cursor-pointer px-3 py-1 bg-blueDim text-blueCustom text-[10px] font-bold rounded-md hover:bg-blue-600/20 transition-colors border border-blueBorder/30">
                                <IconPlus /> Importă Doc (PDF/XLSX)
                                <input type="file" accept=".xlsx, .xls, .pdf" multiple className="hidden"
                                    onChange={(e) => window.handleEnterpriseImport(e, ent.id)} />
                            </label>
                        </div>
                    </div>

                    <div className="flex gap-3 flex-wrap mb-6">
                        <TextInput label="Nume întreprindere" value={ent.name} onChange={v => onChange("name", v)} placeholder="SC Exemplu SRL" />
                        <TextInput label="CUI / CIF" value={ent.cui} onChange={v => onChange("cui", v)} placeholder="RO12345678" />
                        <SelectInput label="Tip relație" value={ent.type} onChange={v => onChange("type", v)}
                            options={[
                                { value: "linked", label: "Legată (>50%)" },
                                { value: "partner", label: "Parteneră (25-50%)" },
                            ]} />
                        <NumberInput label="% participare" value={ent.percent} onChange={v => onChange("percent", v)} suffix="%" placeholder="51" />
                    </div>

                    <div className="space-y-4">
                        {["2024", "2023", "2022"].map(year => (
                            <div key={year} className="p-3 border border-border/30 rounded-lg bg-card/40 flex gap-4 flex-wrap items-end">
                                <div className="text-[10px] font-bold text-textMuted uppercase mb-1 min-w-[50px]">{year}</div>
                                <NumberInput label="Salariați" value={ent[`employees${year}`]} onChange={v => onChange(`employees${year}`, v)} />
                                <NumberInput label="Cifră Afaceri (EUR)" value={ent[`turnover${year}`]} onChange={v => onChange(`turnover${year}`, v)} suffix="€" />
                                <NumberInput label="Active Totale (EUR)" value={ent[`assets${year}`]} onChange={v => onChange(`assets${year}`, v)} suffix="€" />
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        function IMMVerifier() {
            const [step, setStep] = useState(0);
            const steps = ["Clasificare", "Date companie", "Întreprinderi legate", "Verificare IMM"];

            // Step 1 – Classification
            const [classification, setClassification] = useState("linked");

            // Step 2 – Company data (A) – Pre-populated: ALEX AUTOFINEAS SRL
            const [company, setCompany] = useState({
                name: "ALEX AUTOFINEAS S.R.L.", cui: "40712610",
                employees2024: 7, turnover2024: 790342, assets2024: 533145,
                employees2023: 4, turnover2023: 477638, assets2023: 442362,
                employees2022: 4, turnover2022: 313086, assets2022: 141568,
            });

            // Step 3 – Related enterprises – Pre-populated: ALEX AUTOFAD SRL (legată 100%)
            const [enterprises, setEnterprises] = useState([{
                id: 1, name: "ALEX AUTOFAD S.R.L.", cui: "28986993", type: "linked", percent: 100,
                employees2024: 3, turnover2024: 55368, assets2024: 29236,
                employees2023: 3, turnover2023: 59466, assets2023: 30875,
                employees2022: 2, turnover2022: 43766, assets2022: 44982,
            }]);

            // DOCX-specific state
            const [docxData, setDocxData] = useState({
                projectTitle: "",
                smisCode: "",
                financingRequestNumber: "",
                financingRequestDate: "",
                // Shareholder analysis
                hasLegalPersonShareholders: null,
                isCalculationCorrect: null,
                hasNaturalPersonRelationships: null,
                isNaturalPersonCalculationCorrect: null,
                // Governance analysis
                hasBoardMajorityAppointed: null,
                hasSingleShareholderControl: null,
                // Market dependency
                hasDominantClient: null,
                hasDependentSupplier: null,
                // Evaluator
                evaluatorName: "",
                evaluationDate: new Date().toISOString().split('T')[0],
                // Observations
                observations: {},
            });
            const updateDocxData = (field, value) => setDocxData(prev => ({ ...prev, [field]: value }));
            const updateObservation = (key, value) => setDocxData(prev => ({
                ...prev,
                observations: { ...prev.observations, [key]: value }
            }));
            const [docxSectionsOpen, setDocxSectionsOpen] = useState({
                project: true, shareholders: false, governance: false, market: false, evaluator: false
            });
            const toggleDocxSection = (key) => setDocxSectionsOpen(prev => ({ ...prev, [key]: !prev[key] }));

            // Projects database (imported from Excel)
            const [projectsDB, setProjectsDB] = useState(() => {
                try {
                    const stored = localStorage.getItem("imm_projects_db");
                    if (stored) return JSON.parse(stored);
                } catch (e) {}
                return [];
            });

            const importProjectsExcel = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const data = new Uint8Array(evt.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const ws = workbook.Sheets[workbook.SheetNames[0]];
                        const rows = XLSX.utils.sheet_to_json(ws, { defval: "" });

                        const projects = rows.map((row, idx) => {
                            // Flexible column matching
                            const findCol = (keys) => {
                                for (const key of Object.keys(row)) {
                                    const k = key.toLowerCase().replace(/[^a-z0-9]/g, '');
                                    for (const search of keys) {
                                        if (k.includes(search)) return row[key];
                                    }
                                }
                                return "";
                            };

                            // Format date if it's a JS Date or serial number
                            let dateVal = findCol(["datadepunere", "datacerere", "data", "date"]);
                            if (dateVal instanceof Date) {
                                dateVal = dateVal.toLocaleDateString('ro-RO');
                            } else if (typeof dateVal === 'number') {
                                // Excel serial date
                                const d = new Date((dateVal - 25569) * 86400 * 1000);
                                dateVal = d.toLocaleDateString('ro-RO');
                            }

                            return {
                                id: Date.now() + idx,
                                solicitant: String(findCol(["solicitant", "beneficiar", "firma", "denumire"]) || "").trim(),
                                projectTitle: String(findCol(["titluproiect", "titlu", "proiect"]) || "").trim(),
                                smisCode: String(findCol(["codsmis", "smis"]) || "").trim(),
                                referenceNumber: String(findCol(["numaruldereferinta", "referinta", "nrref"]) || "").trim(),
                                financingRequestDate: String(dateVal || "").trim(),
                            };
                        }).filter(p => p.solicitant);

                        if (projects.length === 0) {
                            alert("Nu s-au gasit proiecte in fisierul Excel.\n\nAsigurati-va ca exista o coloana 'Solicitant'.");
                            return;
                        }

                        setProjectsDB(projects);
                        localStorage.setItem("imm_projects_db", JSON.stringify(projects));
                        alert(`${projects.length} proiect(e) importate cu succes!`);
                    } catch (err) {
                        console.error("Projects import error:", err);
                        alert("Eroare la importul fisierului Excel cu proiecte: " + err.message);
                    }
                };
                reader.readAsArrayBuffer(file);
                e.target.value = '';
            };

            // Normalize company name for fuzzy matching
            const normalizeName = (name) => {
                if (!name) return "";
                return name.toUpperCase()
                    .replace(/\bS\.?C\.?\b/g, '')
                    .replace(/\bS\.?R\.?L\.?\b/g, '')
                    .replace(/\bS\.?A\.?\b/g, '')
                    .replace(/[.\-,;'"]/g, '')
                    .replace(/\s+/g, ' ')
                    .trim();
            };

            // Auto-fill project data when company name matches a Solicitant
            const lookupProjectByName = useCallback((companyName) => {
                if (!companyName || projectsDB.length === 0) return;
                const normalized = normalizeName(companyName);
                if (normalized.length < 3) return;

                // Try exact match first, then fuzzy
                let match = projectsDB.find(p => normalizeName(p.solicitant) === normalized);
                if (!match) {
                    // Try partial match (company name contained in solicitant or vice-versa)
                    match = projectsDB.find(p => {
                        const ns = normalizeName(p.solicitant);
                        return ns.includes(normalized) || normalized.includes(ns);
                    });
                }

                if (match) {
                    setDocxData(prev => ({
                        ...prev,
                        projectTitle: match.projectTitle || prev.projectTitle,
                        smisCode: match.smisCode || prev.smisCode,
                        financingRequestNumber: match.referenceNumber || prev.financingRequestNumber,
                        financingRequestDate: match.financingRequestDate || prev.financingRequestDate,
                    }));
                    return match;
                }
                return null;
            }, [projectsDB]);

            // Auto-lookup when company name changes
            useEffect(() => {
                if (company.name && projectsDB.length > 0) {
                    lookupProjectByName(company.name);
                }
            }, [company.name, projectsDB, lookupProjectByName]);

            const addEnterprise = () => setEnterprises(prev => [...prev, {
                id: Date.now(), name: "", cui: "", type: "linked", percent: null,
                employees2024: null, turnover2024: null, assets2024: null,
                employees2023: null, turnover2023: null, assets2023: null,
                employees2022: null, turnover2022: null, assets2022: null,
            }]);

            const addEnterpriseOfType = (type) => setEnterprises(prev => [...prev, {
                id: Date.now(), name: "", cui: "", type: type, percent: null,
                employees2024: null, turnover2024: null, assets2024: null,
                employees2023: null, turnover2023: null, assets2023: null,
                employees2022: null, turnover2022: null, assets2022: null,
            }]);

            const downloadExcel = () => {
                try {
                    // Load template from base64
                    const binary = atob(TEMPLATE_B64);
                    const bytes = new Uint8Array(binary.length);
                    for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
                    const workbook = XLSX.read(bytes, { type: 'array' });
                    const ws = workbook.Sheets[workbook.SheetNames[0]];

                    const setVal = (cell, val) => {
                        if (!ws[cell]) ws[cell] = {};
                        ws[cell].v = val;
                        ws[cell].t = typeof val === 'number' ? 'n' : 's';
                    };

                    // Convert EUR back to LEI for the template (template works in LEI)
                    const toLei = (eurVal) => Math.round((eurVal || 0) * EUR_RON);

                    // Header
                    setVal('B1', `Denumire beneficiar: ${company.name || ''}`);
                    setVal('B2', `CUI: ${company.cui || ''}`);

                    // ─── Year N (rows 1-31) — 2024 data ───
                    setVal('C6', `${company.name} / ${company.cui}`);
                    setVal('C7', toLei(company.turnover2024));
                    setVal('C11', toLei(company.assets2024));
                    setVal('C12', company.employees2024 || 0);

                    // ─── Year N-1 (rows 33-62) — 2023 data ───
                    setVal('C37', `${company.name} / ${company.cui}`);
                    setVal('C38', toLei(company.turnover2023));
                    setVal('C42', toLei(company.assets2023));
                    setVal('C43', company.employees2023 || 0);

                    // ─── Year N-2 (rows 64-93) — 2022 data ───
                    setVal('C68', `${company.name} / ${company.cui}`);
                    setVal('C69', toLei(company.turnover2022));
                    setVal('C73', toLei(company.assets2022));
                    setVal('C74', company.employees2022 || 0);

                    // ─── Linked/Partner enterprises ───
                    // Linked firms columns: G, L, Q, V, AB, AH, AM, AR, AX, BE, BJ, BP, BV
                    const linkedCols = ['G', 'L', 'Q', 'V', 'AB', 'AH', 'AM', 'AR', 'AX', 'BE', 'BJ', 'BP', 'BV'];
                    const partnerCols = linkedCols; // same columns but in partner section

                    const linkedEnts = enterprises.filter(e => e.type === 'linked');
                    const partnerEnts = enterprises.filter(e => e.type === 'partner');

                    linkedEnts.forEach((ent, idx) => {
                        if (idx >= 13) return;
                        const col = linkedCols[idx];
                        // Year N
                        setVal(`${col}6`, ent.name || '');
                        setVal(`${col}7`, toLei(ent.turnover2024));
                        setVal(`${col}11`, toLei(ent.assets2024));
                        setVal(`${col}12`, ent.employees2024 || 0);
                        // Year N-1
                        setVal(`${col}37`, ent.name || '');
                        setVal(`${col}38`, toLei(ent.turnover2023));
                        setVal(`${col}42`, toLei(ent.assets2023));
                        setVal(`${col}43`, ent.employees2023 || 0);
                        // Year N-2
                        setVal(`${col}68`, ent.name || '');
                        setVal(`${col}69`, toLei(ent.turnover2022));
                        setVal(`${col}73`, toLei(ent.assets2022));
                        setVal(`${col}74`, ent.employees2022 || 0);
                    });

                    partnerEnts.forEach((ent, idx) => {
                        if (idx >= 13) return;
                        const col = partnerCols[idx];
                        const pct = (ent.percent || 50) / 100;
                        // Year N
                        setVal(`${col}15`, pct);
                        setVal(`${col}16`, ent.name || '');
                        setVal(`${col}17`, toLei(ent.turnover2024));
                        setVal(`${col}21`, toLei(ent.assets2024));
                        setVal(`${col}22`, ent.employees2024 || 0);
                        // Year N-1
                        setVal(`${col}46`, pct);
                        setVal(`${col}47`, ent.name || '');
                        setVal(`${col}48`, toLei(ent.turnover2023));
                        setVal(`${col}52`, toLei(ent.assets2023));
                        setVal(`${col}53`, ent.employees2023 || 0);
                        // Year N-2
                        setVal(`${col}77`, pct);
                        setVal(`${col}78`, ent.name || '');
                        setVal(`${col}79`, toLei(ent.turnover2022));
                        setVal(`${col}83`, toLei(ent.assets2022));
                        setVal(`${col}84`, ent.employees2022 || 0);
                    });

                    // Download
                    const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
                    const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Criteriu_IMM_${company.name || 'Firma'}_${new Date().toISOString().split('T')[0]}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } catch (err) {
                    console.error("Excel download error:", err);
                    alert("Eroare la generarea fișierului Excel: " + err.message);
                }
            };

            const downloadDocx = async () => {
                try {
                    const { Document, Packer, Paragraph, Table, TableRow, TableCell,
                        TextRun, WidthType, BorderStyle, AlignmentType,
                        HeadingLevel, VerticalAlign, HeightRule, TableLayoutType,
                        convertInchesToTwip, ShadingType } = docx;

                    const BORDER = { style: BorderStyle.SINGLE, size: 1, color: "000000" };
                    const BORDERS_ALL = { top: BORDER, bottom: BORDER, left: BORDER, right: BORDER };
                    const BORDERS_NONE = {
                        top: { style: BorderStyle.NONE, size: 0 },
                        bottom: { style: BorderStyle.NONE, size: 0 },
                        left: { style: BorderStyle.NONE, size: 0 },
                        right: { style: BorderStyle.NONE, size: 0 }
                    };

                    const makeCell = (text, opts = {}) => {
                        const { bold, size, width, colspan, rowspan, align, shading, vAlign } = opts;
                        const cellOpts = {
                            children: [new Paragraph({
                                children: [new TextRun({ text: text || "", bold: bold || false, size: size || 18, font: "Arial" })],
                                alignment: align || AlignmentType.LEFT,
                                spacing: { before: 40, after: 40 },
                            })],
                            borders: BORDERS_ALL,
                            verticalAlign: vAlign || VerticalAlign.CENTER,
                        };
                        if (width) cellOpts.width = { size: width, type: WidthType.DXA };
                        if (colspan) cellOpts.columnSpan = colspan;
                        if (rowspan) cellOpts.rowSpan = rowspan;
                        if (shading) cellOpts.shading = { type: ShadingType.CLEAR, fill: shading };
                        return new TableCell(cellOpts);
                    };

                    const makeMultiCell = (runs, opts = {}) => {
                        const { width, colspan, rowspan, align, shading, vAlign } = opts;
                        const cellOpts = {
                            children: [new Paragraph({
                                children: runs.map(r => new TextRun({ text: r.text || "", bold: r.bold || false, size: r.size || 18, font: "Arial", break: r.break ? 1 : undefined })),
                                alignment: align || AlignmentType.LEFT,
                                spacing: { before: 40, after: 40 },
                            })],
                            borders: BORDERS_ALL,
                            verticalAlign: vAlign || VerticalAlign.CENTER,
                        };
                        if (width) cellOpts.width = { size: width, type: WidthType.DXA };
                        if (colspan) cellOpts.columnSpan = colspan;
                        if (rowspan) cellOpts.rowSpan = rowspan;
                        if (shading) cellOpts.shading = { type: ShadingType.CLEAR, fill: shading };
                        return new TableCell(cellOpts);
                    };

                    const checkMark = (val, expected) => val === expected ? "X" : "";

                    // Determine classification text
                    const classifText = classification === "autonomous" ? "intreprindere autonoma"
                        : classification === "partner" ? "intreprindere partenera"
                        : classification === "mixed" ? "intreprindere mixta (legata si partenera)"
                        : "intreprindere legata";

                    // Determine enterprise names for linked/partner
                    const linkedNames = classification === "mixed"
                        ? `Legate: ${enterprises.filter(e => e.type === "linked").map(e => e.name).filter(Boolean).join(', ') || 'N/A'}; Partenere: ${enterprises.filter(e => e.type === "partner").map(e => e.name).filter(Boolean).join(', ') || 'N/A'}`
                        : enterprises.map(e => `${e.name || ''}${e.name ? ' - CUI ...' : ''}`).filter(Boolean).join(', ') || '';

                    // Classification result
                    const catMap = { "Micro": "Microintreprindere", "Mică": "Intreprindere mica", "Mijlocie": "Intreprindere mijlocie", "Mare": "Intreprindere mare" };
                    const finalCat = calculations.finalCategory;

                    // ═══ TABLE 0 — Header ═══
                    const headerTable = new Table({
                        width: { size: 100, type: WidthType.PERCENTAGE },
                        rows: [
                            new TableRow({
                                children: [
                                    makeCell("MINISTERUL INVESTITIILOR SI PROIECTELOR EUROPENE\nDirectia Generala Program Dezvoltare Durabila si Tranzitie Justa", { bold: true, size: 16, width: 4000, rowspan: 2 }),
                                    makeCell("PROCEDURA OPERATIONALA", { bold: true, size: 16, align: AlignmentType.CENTER }),
                                    makeCell("PO.DGTJCE.93", { bold: true, size: 16, align: AlignmentType.CENTER, colspan: 2 }),
                                ]
                            }),
                            new TableRow({
                                children: [
                                    makeCell("EVALUAREA si SELECTIA PROIECTELOR FINANTATE PRIN PROGRAMUL TRANZITIE JUSTA", { bold: true, size: 16, align: AlignmentType.CENTER }),
                                    makeCell("Editia I", { size: 16, align: AlignmentType.CENTER }),
                                    makeCell("Revizia 1", { size: 16, align: AlignmentType.CENTER }),
                                ]
                            }),
                        ]
                    });

                    // ═══ TABLE 1 — Project Info ═══
                    const projectInfoTable = new Table({
                        width: { size: 100, type: WidthType.PERCENTAGE },
                        rows: [
                            new TableRow({
                                children: [
                                    makeMultiCell([
                                        { text: "Titlu Proiect: ", bold: true, size: 18 },
                                        { text: docxData.projectTitle || "..................", size: 18 },
                                        { text: "Cod SMIS: ", bold: true, size: 18, break: true },
                                        { text: docxData.smisCode || "..................", size: 18 },
                                        { text: "Solicitant: ", bold: true, size: 18, break: true },
                                        { text: company.name || "..................", size: 18 },
                                        { text: "CUI: ", bold: true, size: 18, break: true },
                                        { text: company.cui || "..................", size: 18 },
                                        { text: "Numarul si data Cererii de finantare: ", bold: true, size: 18, break: true },
                                        { text: `nr. ${docxData.financingRequestNumber || "........"} din ${docxData.financingRequestDate || ".........."}`, size: 18 },
                                    ]),
                                ]
                            }),
                        ]
                    });

                    // ═══ Title paragraphs ═══
                    const titlePara1 = new Paragraph({
                        children: [new TextRun({ text: "Lista de verificare privind tipul intreprinderii", bold: true, size: 22, font: "Arial" })],
                        alignment: AlignmentType.CENTER,
                        spacing: { before: 200, after: 100 },
                    });
                    const titlePara2 = new Paragraph({
                        children: [new TextRun({ text: "din punct de vedere al numarului de angajati si cifra de afaceri/active totale, conform prevederilor Legii nr. 346/2004", size: 18, font: "Arial" })],
                        alignment: AlignmentType.CENTER,
                        spacing: { after: 100 },
                    });
                    const titlePara3 = new Paragraph({
                        children: [new TextRun({ text: "Daca Solicitantul se declara intreprindere mare, se verifica doar cerinta de la pct.IV, al.4.", italics: true, size: 16, font: "Arial" })],
                        alignment: AlignmentType.CENTER,
                        spacing: { after: 200 },
                    });

                    // ═══ TABLE 2 — Main Verification Checklist ═══
                    const SHADE_HEADER = "D9E2F3";
                    const SHADE_SECTION = "E2EFDA";
                    const COL_REQ = 6000;
                    const COL_DA = 800;
                    const COL_NU = 800;
                    const COL_OBS = 3000;

                    const sectionRow = (text) => new TableRow({
                        children: [
                            makeCell(text, { bold: true, size: 16, colspan: 4, shading: SHADE_SECTION, align: AlignmentType.CENTER }),
                        ]
                    });

                    const checkRow = (label, value, obsKey) => new TableRow({
                        children: [
                            makeCell(label, { size: 16, width: COL_REQ }),
                            makeCell(checkMark(value, "DA"), { size: 16, width: COL_DA, align: AlignmentType.CENTER }),
                            makeCell(checkMark(value, "NU"), { size: 16, width: COL_NU, align: AlignmentType.CENTER }),
                            makeCell(docxData.observations[obsKey] || "", { size: 16, width: COL_OBS }),
                        ]
                    });

                    const conclusionRow = (text) => new TableRow({
                        children: [
                            makeCell("Concluzie:", { bold: true, size: 16, width: COL_REQ }),
                            makeCell(text, { size: 16, colspan: 3 }),
                        ]
                    });

                    const checklistRows = [
                        // Row 0: Enterprise type declaration
                        new TableRow({
                            children: [
                                makeMultiCell([
                                    { text: "Solicitantul se declara ", size: 16 },
                                    { text: classifText, bold: true, size: 16 },
                                    { text: classification !== "autonomous" ? ` cu ${linkedNames}` : "", size: 16 },
                                ], { colspan: 4, shading: SHADE_HEADER }),
                            ]
                        }),

                        // Section I: Shareholder analysis
                        sectionRow("I. Verificarea modului de constituire a capitalului social al Solicitantului (asociati/actionari persoane juridice si persoane fizice)"),

                        // Column headers
                        new TableRow({
                            children: [
                                makeCell("Cerinta", { bold: true, size: 16, width: COL_REQ, shading: SHADE_HEADER, align: AlignmentType.CENTER }),
                                makeCell("DA", { bold: true, size: 16, width: COL_DA, shading: SHADE_HEADER, align: AlignmentType.CENTER }),
                                makeCell("NU", { bold: true, size: 16, width: COL_NU, shading: SHADE_HEADER, align: AlignmentType.CENTER }),
                                makeCell("OBSERVATII", { bold: true, size: 16, width: COL_OBS, shading: SHADE_HEADER, align: AlignmentType.CENTER }),
                            ]
                        }),

                        // 1. Legal persons
                        checkRow(
                            "1. Exista in structura actionariatului/asociatilor Solicitantului persoane juridice care au calitatea de asociat/actionar si care creeaza o relatie de intreprindere partenera sau legata?",
                            docxData.hasLegalPersonShareholders,
                            "legalPerson"
                        ),

                        // 1.1. Calculation
                        checkRow(
                            "1.1. Datele inscrise in Declaratia pe propria raspundere privind incadrarea intreprinderii in categoria de microintreprinderi/intreprinderi mici si mijlocii sunt corect calculate?",
                            docxData.isCalculationCorrect,
                            "calcCorrect"
                        ),

                        // 2. Natural persons
                        checkRow(
                            "2. Exista in structura actionariatului/asociatilor Solicitantului persoane fizice care, prin participatiile lor la capitalul social sau prin drepturile de vot detinute, creeaza o relatie de intreprindere partenera sau legata cu o alta intreprindere?\n(actiune in comun, membrii familiei, etc.)",
                            docxData.hasNaturalPersonRelationships,
                            "naturalPerson"
                        ),

                        // 2.1. Natural person calculation
                        checkRow(
                            "2.1. Datele privind intreprinderile legate/partenere prin persoane fizice sunt corect calculate in Declaratia IMM?",
                            docxData.isNaturalPersonCalculationCorrect,
                            "naturalCalcCorrect"
                        ),

                        // Conclusion I
                        conclusionRow(
                            docxData.hasLegalPersonShareholders === "NU" && docxData.hasNaturalPersonRelationships === "NU"
                                ? "Nu exista relatii de parteneriat/legatura prin structura actionariatului."
                                : docxData.hasLegalPersonShareholders === "DA" || docxData.hasNaturalPersonRelationships === "DA"
                                    ? "Exista relatii de parteneriat/legatura ce au fost luate in calcul."
                                    : "..."
                        ),

                        // Section II: Governance
                        sectionRow("II. Analiza controlului direct/indirect, inclusiv prin acorduri (verificari suplimentare)"),

                        // 2.1 Board
                        checkRow(
                            "2.1. Majoritatea membrilor organului de administrare, de conducere sau de supraveghere al Solicitantului sunt numiti/revocati de o alta intreprindere?",
                            docxData.hasBoardMajorityAppointed,
                            "boardMajority"
                        ),

                        // 2.2 Single shareholder control
                        checkRow(
                            "2.2. Un actionar/asociat unic controleaza singur, in baza unui acord incheiat cu alti actionari/asociati, majoritatea drepturilor de vot?",
                            docxData.hasSingleShareholderControl,
                            "shareholderControl"
                        ),

                        // Conclusion II
                        conclusionRow(
                            docxData.hasBoardMajorityAppointed === "NU" && docxData.hasSingleShareholderControl === "NU"
                                ? "Nu exista control direct/indirect suplimentar."
                                : "Exista relatii de control ce au fost analizate."
                        ),

                        // Section III: Market dependency
                        sectionRow("III. Analiza politicilor financiare/operationale ale intreprinderilor partenere (25%-50%)"),

                        // 3.1 Client dependency
                        checkRow(
                            "3.1. Exista o intreprindere partenera care este client cu pozitie dominanta pe piata Solicitantului (peste 50% din cifra de afaceri)?",
                            docxData.hasDominantClient,
                            "dominantClient"
                        ),

                        // 3.2 Supplier dependency
                        checkRow(
                            "3.2. Exista o intreprindere partenera care este furnizor cu pozitie dominanta (peste 50% din costurile de productie/aprovizionare)?",
                            docxData.hasDependentSupplier,
                            "dependentSupplier"
                        ),

                        // Conclusion III
                        conclusionRow(
                            docxData.hasDominantClient === "NU" && docxData.hasDependentSupplier === "NU"
                                ? "Nu exista dependenta de piata cu intreprinderi partenere."
                                : "Exista dependenta de piata ce a fost analizata."
                        ),

                        // Section IV: Classification
                        sectionRow("IV. Verificare incadrare conform Legii 346/2004 (pe baza datelor din Declaratia IMM)"),

                        // Micro
                        new TableRow({
                            children: [
                                makeCell("Microintreprindere: pana la 9 salariati; cifra de afaceri anuala neta sau activele totale de pana la 2 milioane euro", { size: 16, width: COL_REQ }),
                                makeCell(finalCat === "Micro" ? "X" : "", { size: 16, width: COL_DA, align: AlignmentType.CENTER }),
                                makeCell(finalCat === "Micro" ? "" : "X", { size: 16, width: COL_NU, align: AlignmentType.CENTER }),
                                makeCell("", { size: 16, width: COL_OBS }),
                            ]
                        }),

                        // Small
                        new TableRow({
                            children: [
                                makeCell("Intreprindere mica: de la 10 pana la 49 de salariati; cifra de afaceri anuala neta sau activele totale de pana la 10 milioane euro", { size: 16, width: COL_REQ }),
                                makeCell(finalCat === "Mică" ? "X" : "", { size: 16, width: COL_DA, align: AlignmentType.CENTER }),
                                makeCell(finalCat === "Mică" ? "" : "X", { size: 16, width: COL_NU, align: AlignmentType.CENTER }),
                                makeCell("", { size: 16, width: COL_OBS }),
                            ]
                        }),

                        // Medium
                        new TableRow({
                            children: [
                                makeCell("Intreprindere mijlocie: de la 50 pana la 249 de salariati; cifra de afaceri anuala neta de pana la 50 milioane euro sau active totale de pana la 43 milioane euro", { size: 16, width: COL_REQ }),
                                makeCell(finalCat === "Mijlocie" ? "X" : "", { size: 16, width: COL_DA, align: AlignmentType.CENTER }),
                                makeCell(finalCat === "Mijlocie" ? "" : "X", { size: 16, width: COL_NU, align: AlignmentType.CENTER }),
                                makeCell("", { size: 16, width: COL_OBS }),
                            ]
                        }),

                        // Large
                        new TableRow({
                            children: [
                                makeCell("Intreprindere mare: peste 250 de salariati; cifra de afaceri anuala neta peste 50 milioane euro sau activele totale peste 43 milioane euro", { size: 16, width: COL_REQ }),
                                makeCell(finalCat === "Mare" ? "X" : "", { size: 16, width: COL_DA, align: AlignmentType.CENTER }),
                                makeCell(finalCat === "Mare" ? "" : "X", { size: 16, width: COL_NU, align: AlignmentType.CENTER }),
                                makeCell("", { size: 16, width: COL_OBS }),
                            ]
                        }),

                        // Final conclusion
                        new TableRow({
                            children: [
                                makeMultiCell([
                                    { text: "CONCLUZIE: ", bold: true, size: 16 },
                                    { text: `Solicitantul se incadreaza in categoria `, size: 16 },
                                    { text: catMap[finalCat] || finalCat, bold: true, size: 16 },
                                    { text: `, conform Legii 346/2004, cu respectarea regulii celor 2 ani consecutivi.`, size: 16 },
                                ], { colspan: 4, shading: SHADE_HEADER }),
                            ]
                        }),
                    ];

                    const checklistTable = new Table({
                        width: { size: 100, type: WidthType.PERCENTAGE },
                        rows: checklistRows,
                    });

                    // ═══ TABLE 3 — Signatures ═══
                    const signatureTable = new Table({
                        width: { size: 100, type: WidthType.PERCENTAGE },
                        rows: [
                            new TableRow({
                                children: [
                                    makeCell("Intocmit", { bold: true, size: 16, align: AlignmentType.CENTER, colspan: 2 }),
                                ]
                            }),
                            new TableRow({
                                children: [
                                    makeCell("Nume evaluator:", { bold: true, size: 16 }),
                                    makeCell(docxData.evaluatorName || "", { size: 16 }),
                                ]
                            }),
                            new TableRow({
                                children: [
                                    makeCell("Semnatura:", { bold: true, size: 16 }),
                                    makeCell("", { size: 16 }),
                                ]
                            }),
                            new TableRow({
                                children: [
                                    makeCell("Data:", { bold: true, size: 16 }),
                                    makeCell(docxData.evaluationDate || "", { size: 16 }),
                                ]
                            }),
                        ]
                    });

                    // ═══ Annex paragraphs ═══
                    const annexTitle = new Paragraph({
                        children: [new TextRun({ text: "Anexa la LISTA DE VERIFICARE privind tipul intreprinderii", bold: true, size: 22, font: "Arial" })],
                        alignment: AlignmentType.CENTER,
                        spacing: { before: 400, after: 200 },
                    });

                    const annexSubtitle = new Paragraph({
                        children: [new TextRun({ text: "Considerente cu privire la calculul datelor unei intreprinderi", bold: true, size: 20, font: "Arial" })],
                        alignment: AlignmentType.CENTER,
                        spacing: { after: 200 },
                    });

                    const annexTexts = [
                        "Intreprinderea autonoma - este intreprinderea care nu este nici partenera, nici legata cu alta intreprindere.",
                        "Intreprinderile partenere - sunt intreprinderile care nu sunt intreprinderi legate si intre care exista urmatoarea relatie: intreprinderea detine intre 25% si 50% din capitalul social sau din drepturile de vot ale altei intreprinderi, si/sau o alta intreprindere detine intre 25% si 50% din capitalul social sau din drepturile de vot ale intreprinderii solicitante.",
                        "Intreprinderile legate - sunt intreprinderile intre care exista oricare dintre urmatoarele raporturi: a) o intreprindere detine majoritatea drepturilor de vot ale actionarilor sau ale asociatilor celeilalte intreprinderi; b) o intreprindere are dreptul de a numi sau de a revoca majoritatea membrilor organului de administrare, de conducere sau de supraveghere al celeilalte intreprinderi; c) o intreprindere are dreptul de a exercita o influenta dominanta asupra celeilalte intreprinderi, in temeiul unui contract incheiat cu aceasta intreprindere sau al unei prevederi din actul constitutiv sau din statut; d) o intreprindere care este actionar sau asociat al celeilalte intreprinderi controleaza singura, in baza unui acord incheiat cu alti actionari sau asociati ai acelei intreprinderi, majoritatea drepturilor de vot ale actionarilor sau asociatilor intreprinderii respective.",
                        "Intreprinderile care intretin oricare dintre relatiile de mai sus prin intermediul uneia sau mai multor intreprinderi sau al oricaruia dintre investitorii enumerati in art.4 alin.2 din Legea nr. 346/2004 sunt considerate intreprinderi legate.",
                        "Intreprinderile intre care fiecare dintre relatiile de mai sus se realizeaza prin intermediul unei persoane fizice sau al unui grup de persoane fizice care actioneaza de comun acord sunt considerate intreprinderi legate, daca isi desfasoara activitatea sau o parte din activitate pe aceeasi piata relevanta sau pe piete adiacente.",
                    ];

                    const annexParagraphs = annexTexts.map(txt => new Paragraph({
                        children: [new TextRun({ text: txt, size: 16, font: "Arial" })],
                        spacing: { before: 100, after: 100 },
                    }));

                    const formCode = new Paragraph({
                        children: [new TextRun({ text: "F-PO-DGPDDTJ.93.19", size: 14, font: "Arial", color: "888888" })],
                        alignment: AlignmentType.RIGHT,
                        spacing: { before: 200 },
                    });

                    // ═══ Assemble Document ═══
                    const doc = new Document({
                        sections: [{
                            properties: {
                                page: {
                                    size: { width: convertInchesToTwip(11.69), height: convertInchesToTwip(8.27) },
                                    margin: { top: convertInchesToTwip(0.5), bottom: convertInchesToTwip(0.5), left: convertInchesToTwip(0.6), right: convertInchesToTwip(0.6) },
                                },
                            },
                            children: [
                                headerTable,
                                new Paragraph({ spacing: { before: 100, after: 100 } }),
                                projectInfoTable,
                                titlePara1,
                                titlePara2,
                                titlePara3,
                                checklistTable,
                                new Paragraph({ spacing: { before: 200, after: 200 } }),
                                signatureTable,
                                annexTitle,
                                annexSubtitle,
                                ...annexParagraphs,
                                formCode,
                            ]
                        }]
                    });

                    // Generate and download
                    const blob = await Packer.toBlob(doc);
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Lista_Verificare_IMM_${company.name || 'Firma'}_${new Date().toISOString().split('T')[0]}.docx`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } catch (err) {
                    console.error("DOCX download error:", err);
                    alert("Eroare la generarea documentului DOCX: " + err.message);
                }
            };

            const processSinglePDF = async (file, targetEntId = null) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = async (evt) => {
                        try {
                            const typedarray = new Uint8Array(evt.target.result);
                            const pdf = await pdfjsLib.getDocument(typedarray).promise;
                            let fullText = "";
                            for (let i = 1; i <= pdf.numPages; i++) {
                                const page = await pdf.getPage(i);
                                const content = await page.getTextContent();
                                fullText += content.items.map(item => item.str).join(" ") + "\n";
                            }
                            processFinancialText(fullText, targetEntId);
                            resolve();
                        } catch (err) {
                            console.error("PDF Import error:", err);
                            reject(err);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                });
            };

            const handleImport = async (e, targetEntId = null) => {
                const files = Array.from(e.target.files);
                if (!files.length) return;

                const pdfFiles = files.filter(f => f.type === "application/pdf" || f.name.endsWith(".pdf"));
                const excelFiles = files.filter(f => !f.type.includes("pdf") && !f.name.endsWith(".pdf"));

                // Process all PDFs (supports multiple files for different years)
                if (pdfFiles.length > 0) {
                    window._pdfImportResults = [];
                    for (const file of pdfFiles) {
                        try {
                            await processSinglePDF(file, targetEntId);
                        } catch (err) {
                            window._pdfImportResults.push(`${file.name}: Eroare`);
                        }
                    }
                    // Show single summary alert
                    if (window._pdfImportResults.length > 0) {
                        alert(window._pdfImportResults.join('\n'));
                    }
                    delete window._pdfImportResults;
                }

                // Process Excel (first one only)
                const file = excelFiles[0];
                if (!file) return;

                const reader = new FileReader();
                    reader.onload = (evt) => {
                        try {
                            const data = new Uint8Array(evt.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const sheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[sheetName];

                            // Helper to get value
                            const getVal = (cell) => {
                                const val = worksheet[cell] ? worksheet[cell].v : null;
                                return (val === 0 || val) ? val : null;
                            };

                            if (targetEntId) {
                                // Specific update for an enterprise using "Company A" cells from the file
                                updateEnterprise(targetEntId, "name", getVal('C1'));
                                updateEnterprise(targetEntId, "employees2024", getVal('C13'));
                                updateEnterprise(targetEntId, "turnover2024", getVal('C8'));
                                updateEnterprise(targetEntId, "assets2024", getVal('C12'));
                                updateEnterprise(targetEntId, "employees2023", getVal('C43'));
                                updateEnterprise(targetEntId, "turnover2023", getVal('C38'));
                                updateEnterprise(targetEntId, "assets2023", getVal('C42'));
                                updateEnterprise(targetEntId, "employees2022", getVal('C74'));
                                updateEnterprise(targetEntId, "turnover2022", getVal('C69'));
                                updateEnterprise(targetEntId, "assets2022", getVal('C73'));
                                alert(`Succes! Datele pentru partenerul selectat au fost importate.`);
                            } else {
                                // Global import (A + partners)
                                setCompany(prev => ({
                                    ...prev,
                                    name: getVal('C1') || prev.name,
                                    cui: getVal('C2') || prev.cui,
                                    turnover2024: getVal('C8'), assets2024: getVal('C12'), employees2024: getVal('C13'),
                                    turnover2023: getVal('C38'), assets2023: getVal('C42'), employees2023: getVal('C43'),
                                    turnover2022: getVal('C69'), assets2022: getVal('C73'), employees2022: getVal('C74'),
                                }));

                                const partners = [];
                                const colMaps = [
                                    { name: 'G7', emp24: 'G13', to24: 'F8', as24: 'G12', emp23: 'G43', to23: 'F38', as23: 'G42', emp22: 'G74', to22: 'F69', as22: 'G73' },
                                    { name: 'L7', emp24: 'L13', to24: 'K8', as24: 'L12', emp23: 'L43', to23: 'K38', as23: 'L42', emp22: 'L74', to22: 'K69', as22: 'L73' },
                                    { name: 'Q7', emp24: 'Q13', to24: 'P8', as24: 'Q12', emp23: 'Q43', to23: 'P38', as23: 'Q42', emp22: 'Q74', to22: 'P69', as22: 'Q73' },
                                    { name: 'V7', emp24: 'V13', to24: 'U8', as24: 'V12', emp23: 'V43', to23: 'U38', as23: 'V42', emp22: 'V74', to22: 'U69', as22: 'V73' }
                                ];

                                colMaps.forEach((map, idx) => {
                                    const nameVal = getVal(map.name);
                                    if (nameVal) {
                                        partners.push({
                                            id: Date.now() + idx,
                                            name: nameVal,
                                            type: "linked",
                                            percent: 100,
                                            employees2024: getVal(map.emp24), turnover2024: getVal(map.to24), assets2024: getVal(map.as24),
                                            employees2023: getVal(map.emp23), turnover2023: getVal(map.to23), assets2023: getVal(map.as23),
                                            employees2022: getVal(map.emp22), turnover2022: getVal(map.to22), assets2022: getVal(map.as22),
                                        });
                                    }
                                });

                                if (partners.length > 0) {
                                    setEnterprises(partners);
                                    setClassification("linked");
                                }
                                alert(`Succes! Datele pentru ${company.name || 'Compania A'} ${partners.length > 0 ? `și ${partners.length} parteneri` : ''} au fost importate.`);
                            }
                        } catch (err) {
                            console.error("Import error:", err);
                            alert("Eroare la citirea fișierului Excel.");
                        }
                    };
                    reader.readAsArrayBuffer(file);
            };

            const processFinancialText = (text, targetEntId = null) => {
                // Normalize text: collapse whitespace, fix encoding issues
                const t = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
                // Detect ANAF format using simple keywords that survive any encoding
                const isANAF = /ACTIVE\s+IMOBILIZATE/i.test(t) && /Cifra\s+de\s+afaceri/i.test(t);

                if (isANAF) {
                    // ─── ANAF PDF Format ───
                    // Year: look for "decembrie YYYY" or "31 decembrie YYYY"
                    const yearMatch = t.match(/decembrie\s+(\d{4})/i);
                    const year = yearMatch ? yearMatch[1] : "2024";

                    // CUI: look for sequence of 6+ digits near "identificare" or standalone
                    const cuiMatch = t.match(/identificare[:\s]*(\d{5,})/i) || t.match(/care[:\s]*(\d{5,})/i) || t.match(/cod unic[^:]*:\s*(\d{5,})/i);
                    const cui = cuiMatch ? cuiMatch[1] : null;

                    // PDF.js extracts: [LABEL][ ][VALUE] — use indexOf for exact match
                    // Labels use em dash (\u2013) not hyphen
                    const extractValue = (label) => {
                        const idx = t.indexOf(label);
                        if (idx === -1) return 0;
                        const after = t.substring(idx + label.length, idx + label.length + 40).trim();
                        const numMatch = after.match(/(\d[\d.]*)/);
                        if (numMatch) return parseInt(numMatch[1].replace(/\./g, ''), 10) || 0;
                        if (/^[\s]*[-\u2013]/.test(after) || /^[\s]*0\b/.test(after)) return 0;
                        return 0;
                    };

                    const activeImobilizate = extractValue("ACTIVE IMOBILIZATE \u2013 TOTAL");
                    const activeCirculante = extractValue("ACTIVE CIRCULANTE \u2013 TOTAL");
                    const activeTotaleLei = activeImobilizate + activeCirculante;
                    const cifraAfaceriLei = extractValue("Cifra de afaceri neta");

                    // Employees: find "Numar mediu de salariati" then next number
                    let employees = 0;
                    const empIdx = t.indexOf("Numar mediu de salariati");
                    if (empIdx !== -1) {
                        const empAfter = t.substring(empIdx + 24, empIdx + 60).trim();
                        const empNum = empAfter.match(/(\d+)/);
                        if (empNum) employees = parseInt(empNum[1]) || 0;
                    }

                    // Convert LEI to EUR
                    const turnoverEUR = Math.round(cifraAfaceriLei / EUR_RON);
                    const assetsEUR = Math.round(activeTotaleLei / EUR_RON);

                    if (activeImobilizate === 0 && activeCirculante === 0 && cifraAfaceriLei === 0 && employees === 0) {
                        const msg = `${year}: Nu am reușit extragerea datelor`;
                        if (window._pdfImportResults) window._pdfImportResults.push(msg);
                        else alert(msg);
                        return;
                    }

                    if (targetEntId) {
                        updateEnterprise(targetEntId, `employees${year}`, employees);
                        updateEnterprise(targetEntId, `turnover${year}`, turnoverEUR);
                        updateEnterprise(targetEntId, `assets${year}`, assetsEUR);
                        if (cui) updateEnterprise(targetEntId, "name", `CUI ${cui}`);
                    } else {
                        setCompany(prev => ({
                            ...prev,
                            cui: cui || prev.cui,
                            [`turnover${year}`]: turnoverEUR,
                            [`assets${year}`]: assetsEUR,
                            [`employees${year}`]: employees,
                        }));
                    }
                    const msg = `${year}: CA ${cifraAfaceriLei.toLocaleString('ro-RO')} LEI → ${turnoverEUR.toLocaleString('ro-RO')} EUR | Active ${activeTotaleLei.toLocaleString('ro-RO')} LEI → ${assetsEUR.toLocaleString('ro-RO')} EUR | Sal: ${employees}`;
                    if (window._pdfImportResults) window._pdfImportResults.push(msg);
                    else alert(msg);
                } else {
                    const msg = "Format PDF nerecunoscut.";
                    if (window._pdfImportResults) window._pdfImportResults.push(msg);
                    else alert(msg);
                }
            };

            // ─── Fetch financial data from ANAF API (direct call with CORS proxy fallback) ───
            const fetchFromANAF = async (cui, targetEntId = null) => {
                const cleanCui = String(cui).replace(/\D/g, '');
                if (!cleanCui || cleanCui.length < 4) {
                    alert("CUI invalid. Introduceți un CUI valid (minim 4 cifre).");
                    return;
                }

                const years = ["2024", "2023", "2022"];
                const results = [];
                let companyName = "";
                let fetchOk = false;

                const CORS_PROXIES = [
                    (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`,
                    (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
                ];

                const fetchWithProxy = async (targetUrl) => {
                    // Try direct first
                    try {
                        const resp = await fetch(targetUrl, {
                            headers: { 'Accept': 'application/json' },
                            signal: AbortSignal.timeout(8000)
                        });
                        if (resp.ok) return await resp.json();
                    } catch (e) {
                        console.log("Direct ANAF call failed (CORS), trying proxies...");
                    }
                    // Try CORS proxies
                    for (const proxyFn of CORS_PROXIES) {
                        try {
                            const proxyUrl = proxyFn(targetUrl);
                            const resp = await fetch(proxyUrl, {
                                signal: AbortSignal.timeout(10000)
                            });
                            if (resp.ok) {
                                const text = await resp.text();
                                return JSON.parse(text);
                            }
                        } catch (e) {
                            console.log("Proxy failed, trying next...");
                        }
                    }
                    return null;
                };

                for (const year of years) {
                    const anafUrl = `https://webservicesp.anaf.ro/bilant?an=${year}&cui=${cleanCui}`;
                    let data = null;

                    try {
                        data = await fetchWithProxy(anafUrl);
                        if (data && data.i) fetchOk = true;
                    } catch (e) {
                        console.error(`ANAF fetch error ${year}:`, e);
                    }

                    if (!data || !data.i) {
                        results.push(`${year}: Nu s-au găsit date`);
                        continue;
                    }

                    if (data.deni) companyName = data.deni;

                    const getIndicator = (code) => {
                        const item = data.i.find(x => x.indicator === code);
                        return item ? item.val_indicator : 0;
                    };

                    const activeImob = getIndicator("I1");
                    const activeCirc = getIndicator("I2");
                    const activeTotalLei = activeImob + activeCirc;
                    const cifraAfaceriLei = getIndicator("I13");
                    const employees = getIndicator("I20");

                    const turnoverEUR = Math.round(cifraAfaceriLei / EUR_RON);
                    const assetsEUR = Math.round(activeTotalLei / EUR_RON);

                    if (targetEntId) {
                        updateEnterprise(targetEntId, `employees${year}`, employees);
                        updateEnterprise(targetEntId, `turnover${year}`, turnoverEUR);
                        updateEnterprise(targetEntId, `assets${year}`, assetsEUR);
                        if (companyName) updateEnterprise(targetEntId, "name", companyName);
                        updateEnterprise(targetEntId, "cui", cleanCui);
                    } else {
                        setCompany(prev => ({
                            ...prev,
                            cui: cleanCui,
                            name: companyName || prev.name,
                            [`turnover${year}`]: turnoverEUR,
                            [`assets${year}`]: assetsEUR,
                            [`employees${year}`]: employees,
                        }));
                    }

                    results.push(`${year}: CA ${cifraAfaceriLei.toLocaleString('ro-RO')} LEI → ${turnoverEUR.toLocaleString('ro-RO')} EUR | Active ${activeTotalLei.toLocaleString('ro-RO')} LEI → ${assetsEUR.toLocaleString('ro-RO')} EUR | Sal: ${employees}`);
                }

                if (!fetchOk) {
                    alert("Nu s-au putut prelua datele de la ANAF.\n\nAlternative:\n1. Încărcați bilanțurile PDF descărcate de pe mfinante.gov.ro\n2. Introduceți datele manual");
                    return;
                }

                alert(`✓ Date importate pentru CUI ${cleanCui}${companyName ? ` (${companyName})` : ''}\n\n${results.join('\n')}`);
            };

            const [cuiLoading, setCuiLoading] = useState(false);

            const handleCuiFetch = async (targetEntId = null, cuiOverride = null) => {
                const cuiValue = cuiOverride || (targetEntId
                    ? prompt("Introduceți CUI-ul firmei:")
                    : company.cui);
                if (!cuiValue) {
                    alert("Introduceți CUI-ul firmei mai întâi.");
                    return;
                }
                setCuiLoading(true);
                try {
                    await fetchFromANAF(cuiValue, targetEntId);
                } catch (err) {
                    console.error("ANAF fetch error:", err);
                    alert("Eroare la preluarea datelor de la ANAF.");
                }
                setCuiLoading(false);
            };

            const updateEnterprise = (id, field, value) => {
                if (value === null || value === undefined) return;
                setEnterprises(prev => prev.map(ent => ent.id === id ? { ...ent, [field]: value } : ent));
            };

            window.handleEnterpriseImport = handleImport;

            const removeEnterprise = (id) => setEnterprises(prev => prev.filter(e => e.id !== id));

            // ─── Calculations (Step 4) ───
            const calculations = useMemo(() => {
                const calc = (yearSuffix) => {
                    const empA = company[`employees${yearSuffix}`] || 0;
                    const toA = company[`turnover${yearSuffix}`] || 0;
                    const asA = company[`assets${yearSuffix}`] || 0;

                    let empAdd = 0, toAdd = 0, asAdd = 0;

                    if (classification !== "autonomous") {
                        enterprises.forEach(ent => {
                            const pct = (ent.percent || 0) / 100;
                            const factor = ent.type === "linked" ? 1 : pct;
                            empAdd += (ent[`employees${yearSuffix}`] || 0) * factor;
                            toAdd += (ent[`turnover${yearSuffix}`] || 0) * factor;
                            asAdd += (ent[`assets${yearSuffix}`] || 0) * factor;
                        });
                    }

                    const totalEmp = empA + empAdd;
                    const totalTO = toA + toAdd;
                    const totalAs = asA + asAdd;

                    const isMicro = totalEmp < 10 && (totalTO < 2000000 || totalAs < 2000000);
                    const isSmall = totalEmp < 50 && (totalTO < 10000000 || totalAs < 10000000);
                    const isMedium = totalEmp < 250 && (totalTO < 50000000 || totalAs < 43000000);

                    let category = "Mare";
                    if (isMicro) category = "Micro";
                    else if (isSmall) category = "Mică";
                    else if (isMedium) category = "Mijlocie";

                    return { totalEmp, totalTO, totalAs, category, isMicro };
                };

                const y2024 = calc("2024");
                const y2023 = calc("2023");
                const y2022 = calc("2022");

                let finalCategory;
                if (y2024.category === y2023.category) {
                    finalCategory = y2024.category;
                } else if (y2023.category === y2022.category) {
                    finalCategory = y2023.category;
                } else {
                    finalCategory = y2022.category;
                }

                const eligible = finalCategory === "Micro";
                return { y2024, y2023, y2022, finalCategory, eligible };
            }, [company, enterprises, classification]);

            const updateCompany = (field, value) => setCompany(prev => ({ ...prev, [field]: value }));

            return (
                <div className="min-h-screen bg-bg text-text p-4 md:p-8">
                    <div className="max-w-4xl mx-auto">
                        <div className="text-center mb-10">
                            <div className="inline-flex items-center gap-3 mb-2">
                                <div className="p-2.5 rounded-xl bg-gradient-to-br from-accent to-orange-600 shadow-lg shadow-accent/20">
                                    <IconBuilding />
                                </div>
                                <h1 className="text-2xl md:text-3xl font-bold text-white tracking-tight">
                                    Verificare IMM <span className="text-accent underline decoration-accent/30 decoration-4 underline-offset-4">PTJ</span>
                                </h1>
                            </div>
                            <p className="text-sm text-textDim max-w-lg mx-auto leading-relaxed">
                                Evaluare conform Anexei 4b la Ghidul Solicitantului PTJ (OMIPE 3672/2025)
                            </p>
                        </div>

                        <StepIndicator steps={steps} current={step} onNavigate={setStep} />

                        {step === 0 && (
                            <Card className="animate-in fade-in duration-500">
                                <h2 className="text-xl font-bold mb-1 flex items-center gap-2">
                                    <span className="text-accent">Pasul 1</span> — Tipul întreprinderii
                                </h2>
                                <p className="text-sm text-textDim mb-6">Stabiliți clasificarea conform Legii 346/2004</p>

                                <div className="space-y-3">
                                    {[
                                        { id: "autonomous", title: "Autonomă", color: "green", desc: "Nicio legătură cu alte firme (sub 25% capital/vot)." },
                                        { id: "partner", title: "Parteneră", color: "blue", desc: "Capital sau voturi între 25% și 50% în/cu altă firmă." },
                                        { id: "linked", title: "Legată", color: "accent", desc: "Control majoritar (>50%) direct sau indirect prin acorduri." },
                                        { id: "mixed", title: "Mixtă", color: "purple", desc: "Combinație: unele firme sunt legate (>50%) și altele sunt partenere (25-50%)." }
                                    ].map(opt => (
                                        <button key={opt.id} onClick={() => setClassification(opt.id)}
                                            className={`w-full text-left p-4 rounded-xl border-2 transition-all flex items-start gap-4
                                                ${classification === opt.id ? `bg-${opt.color}Dim border-${opt.color}Border` : 'bg-cardAlt border-border'}`}>
                                            <div className={`mt-1 w-5 h-5 rounded-full border-2 flex items-center justify-center shrink-0
                                                ${classification === opt.id ? `border-accent bg-accent` : 'border-textMuted'}`}>
                                                {classification === opt.id && <div className="w-2 h-2 bg-bg rounded-full" />}
                                            </div>
                                            <div>
                                                <div className="font-bold mb-0.5">{opt.title}</div>
                                                <div className="text-xs text-textDim leading-relaxed">{opt.desc}</div>
                                            </div>
                                        </button>
                                    ))}
                                </div>

                                <div className="mt-6 flex justify-end">
                                    <button onClick={() => setStep(1)} className="px-8 py-2.5 bg-accent text-bg font-bold rounded-lg hover:opacity-90 transition-opacity">
                                        Continuă →
                                    </button>
                                </div>
                            </Card>
                        )}

                        {step === 1 && (
                            <Card className="animate-in fade-in duration-500">
                                <h2 className="text-xl font-bold mb-1 flex items-center gap-2 text-blueCustom">
                                    Subiectul Analizei (Compania A)
                                </h2>
                                <p className="text-sm text-textDim mb-6">Introduceți datele financiare pentru compania principală (A)</p>

                                <div className="mb-8 p-6 border-2 border-dashed border-blueBorder/30 bg-blueDim/20 rounded-xl group hover:border-blueCustom/50 transition-all flex flex-col items-center justify-center text-center">
                                    <div className="w-12 h-12 rounded-full bg-blueDim text-blueCustom flex items-center justify-center mb-3 group-hover:scale-110 transition-transform">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" y1="3" x2="12" y2="15" /></svg>
                                    </div>
                                    <h3 className="font-bold text-sm mb-1 uppercase tracking-wider">Importă Datele Financiare</h3>
                                    <p className="text-xs text-textDim mb-4 max-w-xs">
                                        Preia automat de la <strong>ANAF</strong> după CUI, sau încarcă <strong>PDF / Excel</strong>.
                                    </p>
                                    <div className="flex gap-3 flex-wrap justify-center">
                                        <button onClick={() => handleCuiFetch()} disabled={cuiLoading}
                                            className="px-6 py-3 bg-accent text-bg text-xs font-bold rounded-xl hover:opacity-90 transition-all shadow-lg shadow-accent/20 disabled:opacity-50 flex items-center gap-2">
                                            {cuiLoading ? (
                                                <><div className="w-4 h-4 border-2 border-bg border-t-transparent rounded-full animate-spin"></div> Se preia...</>
                                            ) : (
                                                <><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg> Import după CUI</>
                                            )}
                                        </button>
                                        <label className="cursor-pointer px-6 py-3 bg-blueCustom text-white text-xs font-bold rounded-xl hover:bg-blue-600 transition-colors shadow-lg shadow-blueCustom/20">
                                            Încarcă PDF / Excel
                                            <input type="file" accept=".xlsx, .xls, .pdf" multiple className="hidden" onChange={handleImport} />
                                        </label>
                                    </div>
                                    <p className="text-[10px] text-textMuted mt-3">Completați mai întâi câmpul CUI pentru import automat</p>
                                </div>

                                <div className="flex items-center gap-2 mb-4 text-blueCustom font-bold uppercase tracking-widest text-[10px]">
                                    <div className="w-5 h-5 rounded bg-blueCustom text-bg flex items-center justify-center text-[10px]">A</div>
                                    Date financiare A
                                </div>

                                <div className="flex gap-4 flex-wrap mb-8">
                                    <TextInput label="Denumire" value={company.name} onChange={v => updateCompany("name", v)} placeholder="SC Exemplu SRL" />
                                    <TextInput label="CUI / CIF" value={company.cui} onChange={v => updateCompany("cui", v)} placeholder="RO12345678" />
                                </div>

                                {["2024", "2023", "2022"].map(year => (
                                    <div key={year} className="mb-6 p-4 border border-border/50 rounded-xl bg-cardAlt/30">
                                        <div className="flex items-center gap-2 mb-4">
                                            <div className={`w-2 h-2 rounded-full ${year === '2024' ? 'bg-accent' : 'bg-blueCustom'}`} />
                                            <span className="font-bold text-sm tracking-wide">Anul Fiscal {year}</span>
                                        </div>
                                        <div className="flex gap-4 flex-wrap">
                                            <NumberInput label="Salariați" value={company[`employees${year}`]} onChange={v => updateCompany(`employees${year}`, v)} />
                                            <NumberInput label="Cifră Afaceri (EUR)" value={company[`turnover${year}`]} onChange={v => updateCompany(`turnover${year}`, v)} suffix="€" />
                                            <NumberInput label="Active Totale (EUR)" value={company[`assets${year}`]} onChange={v => updateCompany(`assets${year}`, v)} suffix="€" />
                                        </div>
                                    </div>
                                ))}

                                <div className="flex justify-between items-center mt-8">
                                    <button onClick={() => setStep(0)} className="text-sm text-textDim hover:text-text">← Înapoi</button>
                                    <button onClick={() => setStep(classification === 'autonomous' ? 3 : 2)} className="px-8 py-2.5 bg-accent text-bg font-bold rounded-lg hover:opacity-90 transition-opacity">
                                        {classification === 'autonomous' ? 'Vezi rezultatul →' : 'Continuă →'}
                                    </button>
                                </div>
                            </Card>
                        )}

                        {step === 2 && (
                            <Card className="animate-in fade-in duration-500">
                                {classification === "mixed" ? (
                                    <>
                                        <h2 className="text-xl font-bold mb-1 text-purpleCustom">Întreprinderi Mixte — Legate și Partenere</h2>
                                        <p className="text-sm text-textDim mb-6">
                                            Adăugați separat întreprinderile legate ({'>'}50%) și partenere (25-50%).
                                            Fiecare grup folosește o metodă de calcul diferită.
                                        </p>

                                        {/* ── SECȚIUNE LEGATE ── */}
                                        <div className="mb-6">
                                            <div className="flex items-center gap-2 mb-3 px-2">
                                                <div className="w-3 h-3 rounded-full bg-accent"></div>
                                                <h3 className="text-sm font-bold uppercase tracking-wider text-accent">
                                                    Întreprinderi Legate ({'>'}50%)
                                                </h3>
                                                <span className="text-[10px] text-textMuted ml-auto bg-accentDim px-2 py-0.5 rounded-full border border-accentBorder/30">
                                                    Se adună 100% din date
                                                </span>
                                            </div>
                                            <div className="border-l-4 border-accent/30 pl-4 space-y-3">
                                                {enterprises.filter(e => e.type === "linked").map((ent, idx) => (
                                                    <EnterpriseRow key={ent.id} ent={ent} index={idx}
                                                        onChange={(f, v) => updateEnterprise(ent.id, f, v)}
                                                        onRemove={() => removeEnterprise(ent.id)}
                                                        onFetchANAF={(entId, cui) => handleCuiFetch(entId, cui)}
                                                        anafLoading={cuiLoading}
                                                        showRemove={true} />
                                                ))}
                                                {enterprises.filter(e => e.type === "linked").length === 0 && (
                                                    <div className="text-xs text-textMuted italic py-3 text-center">Nicio firmă legată adăugată încă.</div>
                                                )}
                                                <button onClick={() => addEnterpriseOfType("linked")}
                                                    className="w-full py-3 border-2 border-dashed border-accentBorder bg-accentDim text-accent rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-accent/20 transition-colors text-sm">
                                                    <IconPlus /> Adaugă firmă legată
                                                </button>
                                            </div>
                                        </div>

                                        {/* ── SEPARATOR ── */}
                                        <div className="flex items-center gap-3 my-6">
                                            <div className="flex-1 h-px bg-border"></div>
                                            <span className="text-xs font-bold text-purpleCustom uppercase tracking-widest px-3 py-1 bg-purpleDim rounded-full border border-purpleBorder/30">și</span>
                                            <div className="flex-1 h-px bg-border"></div>
                                        </div>

                                        {/* ── SECȚIUNE PARTENERE ── */}
                                        <div className="mb-4">
                                            <div className="flex items-center gap-2 mb-3 px-2">
                                                <div className="w-3 h-3 rounded-full bg-blueCustom"></div>
                                                <h3 className="text-sm font-bold uppercase tracking-wider text-blueCustom">
                                                    Întreprinderi Partenere (25-50%)
                                                </h3>
                                                <span className="text-[10px] text-textMuted ml-auto bg-blueDim px-2 py-0.5 rounded-full border border-blueBorder/30">
                                                    Se adună proporțional (% participare)
                                                </span>
                                            </div>
                                            <div className="border-l-4 border-blueCustom/30 pl-4 space-y-3">
                                                {enterprises.filter(e => e.type === "partner").map((ent, idx) => (
                                                    <EnterpriseRow key={ent.id} ent={ent}
                                                        index={enterprises.filter(e2 => e2.type === "linked").length + idx}
                                                        onChange={(f, v) => updateEnterprise(ent.id, f, v)}
                                                        onRemove={() => removeEnterprise(ent.id)}
                                                        onFetchANAF={(entId, cui) => handleCuiFetch(entId, cui)}
                                                        anafLoading={cuiLoading}
                                                        showRemove={true} />
                                                ))}
                                                {enterprises.filter(e => e.type === "partner").length === 0 && (
                                                    <div className="text-xs text-textMuted italic py-3 text-center">Nicio firmă parteneră adăugată încă.</div>
                                                )}
                                                <button onClick={() => addEnterpriseOfType("partner")}
                                                    className="w-full py-3 border-2 border-dashed border-blueBorder bg-blueDim text-blueCustom rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-blue-600/20 transition-colors text-sm">
                                                    <IconPlus /> Adaugă firmă parteneră
                                                </button>
                                            </div>
                                        </div>
                                    </>
                                ) : (
                                    <>
                                        <h2 className="text-xl font-bold mb-1 text-blueCustom">Companii Partenere / Legate (B, C, D...)</h2>
                                        <p className="text-sm text-textDim mb-6">Cumularea datelor din grup conform clasif. {classification}</p>

                                        <div className="space-y-3">
                                            {enterprises.map((ent, idx) => (
                                                <EnterpriseRow key={ent.id} ent={ent} index={idx}
                                                    onChange={(f, v) => updateEnterprise(ent.id, f, v)}
                                                    onRemove={() => removeEnterprise(ent.id)}
                                                    onFetchANAF={(entId, cui) => handleCuiFetch(entId, cui)}
                                                    anafLoading={cuiLoading}
                                                    showRemove={true} />
                                            ))}
                                        </div>

                                        <button onClick={addEnterprise} className="w-full py-4 border-2 border-dashed border-accentBorder bg-accentDim text-accent rounded-xl font-bold flex items-center justify-center gap-2 mt-4 hover:bg-accent/20 transition-colors">
                                            <IconPlus /> Adaugă firmă din grup
                                        </button>
                                    </>
                                )}

                                <div className="flex justify-between items-center mt-10">
                                    <button onClick={() => setStep(1)} className="text-sm text-textDim">← Înapoi</button>
                                    <button onClick={() => setStep(3)} className="px-8 py-2.5 bg-accent text-bg font-bold rounded-lg shadow-lg shadow-accent/20">
                                        Verifică Final →
                                    </button>
                                </div>
                            </Card>
                        )}

                        {step === 3 && (
                            <div className="space-y-6 animate-in zoom-in duration-500">
                                <Card glow={calculations.eligible ? "rgba(16,185,129,0.3)" : "rgba(239,68,68,0.3)"} className="text-center py-10">
                                    <div className="flex justify-center mb-6">
                                        <div className={`w-16 h-16 rounded-full flex items-center justify-center border-4
                                            ${calculations.eligible ? 'border-greenCustom/20 bg-greenDim text-greenCustom' : 'border-redCustom/20 bg-redDim text-redCustom'}`}>
                                            {calculations.eligible ? <IconCheck /> : <IconX />}
                                        </div>
                                    </div>
                                    <h2 className={`text-3xl font-black mb-2 tracking-tight ${calculations.eligible ? 'text-greenCustom' : 'text-redCustom'}`}>
                                        {calculations.eligible ? "ELIGIBIL" : "NEELIGIBIL"}
                                    </h2>
                                    <div className="text-sm text-textDim flex items-center justify-center gap-2 mb-6">
                                        <span>Încadrare finală:</span>
                                        <Badge color={calculations.eligible ? "green" : "red"}>{calculations.finalCategory}</Badge>
                                    </div>
                                    <div className="text-xs text-textMuted max-w-sm mx-auto leading-relaxed italic">
                                        Confirmarea oficială depășește scopul acestui instrument și necesită validare juridică/financiară.
                                    </div>
                                </Card>

                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    {[
                                        { year: "2024", data: calculations.y2024 },
                                        { year: "2023", data: calculations.y2023 },
                                        { year: "2022", data: calculations.y2022 }
                                    ].map(y => (
                                        <Card key={y.year}>
                                            <div className="flex justify-between items-center mb-4">
                                                <span className="font-bold">{y.year}</span>
                                                <Badge color={y.data.isMicro ? "green" : "red"}>{y.data.category}</Badge>
                                            </div>
                                            <div className="space-y-3">
                                                <div className="flex justify-between text-xs">
                                                    <span className="text-textMuted">Salariați</span>
                                                    <span className="font-mono">{fmt(y.data.totalEmp)}</span>
                                                </div>
                                                <div className="flex justify-between text-xs">
                                                    <span className="text-textMuted">Cifră Afaceri</span>
                                                    <span className="font-mono">{fmtEur(y.data.totalTO)}</span>
                                                </div>
                                                <div className="flex justify-between text-xs">
                                                    <span className="text-textMuted">Active Totale</span>
                                                    <span className="font-mono">{fmtEur(y.data.totalAs)}</span>
                                                </div>
                                            </div>
                                        </Card>
                                    ))}
                                </div>

                                <Card>
                                    <h3 className="font-bold flex items-center gap-2 mb-4 text-sm uppercase tracking-wider text-accent/80">
                                        <IconAlert /> Regula 2 ani consecutivi
                                    </h3>
                                    <div className="text-xs text-textDim leading-relaxed bg-cardAlt/50 p-4 rounded-lg border border-border/50">
                                        {calculations.y2024.category === calculations.y2023.category
                                            ? `Scenariu A: Categoria s-a menținut "${calculations.y2024.category}" timp de 2 ani consecutivi (2023-2024). Aceasta este încadrarea rezultată legal.`
                                            : calculations.y2023.category === calculations.y2022.category
                                                ? `Scenariu B: Categoria s-a menținut "${calculations.y2023.category}" în perioada 2022-2023. Modificarea din 2024 nu produce încă efecte de modificare a statutului IMM.`
                                                : `Scenariu C: Fluctuații constante. Se reține categoria stabilită în primul an analizat (2022): ${calculations.y2022.category}.`
                                        }
                                    </div>
                                </Card>

                                <Card className="bg-gradient-to-br from-blueDim to-transparent border-blueBorder/30">
                                    <div className="flex flex-col md:flex-row items-center justify-between gap-6">
                                        <div className="flex-1">
                                            <h3 className="font-bold text-blueCustom mb-1 flex items-center gap-2">
                                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" y1="15" x2="12" y2="3" /></svg>
                                                Raport Excel Oficial
                                            </h3>
                                            <p className="text-xs text-textDim leading-relaxed">
                                                Descărcați modelul de calcul pentru încadrarea în categoria IMM, completat automat cu datele din această analiză.
                                            </p>
                                        </div>
                                        <button onClick={downloadExcel} className="w-full md:w-auto px-6 py-3 bg-blueCustom text-white font-bold rounded-xl flex items-center justify-center gap-2 hover:bg-blue-600 transition-all shadow-lg shadow-blueCustom/20 group">
                                            Descarcă Excel (.xlsx)
                                            <span className="transform group-hover:translate-y-1 transition-transform">↓</span>
                                        </button>
                                    </div>
                                </Card>

                                <Card className="bg-gradient-to-br from-greenDim to-transparent border-greenBorder/30">
                                    <div className="flex items-center justify-between mb-4">
                                        <h3 className="font-bold text-greenCustom flex items-center gap-2">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" /><polyline points="14 2 14 8 20 8" /><line x1="16" y1="13" x2="8" y2="13" /><line x1="16" y1="17" x2="8" y2="17" /><polyline points="10 9 9 9 8 9" /></svg>
                                            Lista de Verificare (DOCX)
                                        </h3>
                                        <Badge color="green">F-PO-DGPDDTJ.93.19</Badge>
                                    </div>
                                    <p className="text-xs text-textDim leading-relaxed mb-5">
                                        Completati datele suplimentare necesare pentru generarea automata a Listei de Verificare privind tipul intreprinderii.
                                        Clasificarea IMM se completeaza automat din analiza de mai sus.
                                    </p>

                                    {/* Date proiect */}
                                    <CollapsibleSection title="Date proiect" icon="📋" isOpen={docxSectionsOpen.project} onToggle={() => toggleDocxSection('project')}>
                                        {/* Import projects database */}
                                        <div className="mb-4 p-3 bg-cardAlt/50 rounded-lg border border-border/50">
                                            <div className="flex flex-wrap items-center justify-between gap-3">
                                                <div className="flex-1 min-w-[200px]">
                                                    <div className="text-[10px] font-bold text-accent uppercase tracking-wider mb-1">Baza de proiecte</div>
                                                    <p className="text-[11px] text-textDim leading-relaxed">
                                                        {projectsDB.length > 0
                                                            ? <><span className="text-greenCustom font-bold">{projectsDB.length}</span> proiecte incarcate. Datele se completeaza automat dupa numele solicitantului.</>
                                                            : <>Importati fisierul Excel cu lista proiectelor pentru auto-completare.</>
                                                        }
                                                    </p>
                                                </div>
                                                <label className="cursor-pointer px-4 py-2 bg-accentDim border border-accentBorder text-accent text-xs font-bold rounded-lg hover:bg-accent/20 transition-colors flex items-center gap-2">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" y1="3" x2="12" y2="15" /></svg>
                                                    {projectsDB.length > 0 ? "Reimporta" : "Importa"} Excel proiecte
                                                    <input type="file" accept=".xlsx,.xls" className="hidden" onChange={importProjectsExcel} />
                                                </label>
                                            </div>
                                            {docxData.projectTitle && projectsDB.length > 0 && (
                                                <div className="mt-2 px-2 py-1.5 bg-greenDim/30 rounded-md border border-greenBorder/30 text-[10px] text-greenCustom flex items-center gap-1.5">
                                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><path d="M20 6 9 17l-5-5" /></svg>
                                                    Proiect gasit automat pentru "{company.name}"
                                                </div>
                                            )}
                                        </div>

                                        <div className="flex gap-3 flex-wrap">
                                            <TextInput label="Titlu Proiect" value={docxData.projectTitle} onChange={v => updateDocxData("projectTitle", v)} placeholder="Titlul proiectului..." />
                                            <TextInput label="Cod SMIS" value={docxData.smisCode} onChange={v => updateDocxData("smisCode", v)} placeholder="351865" />
                                        </div>
                                        <div className="flex gap-3 flex-wrap mt-3">
                                            <TextInput label="Nr. Cerere finantare" value={docxData.financingRequestNumber} onChange={v => updateDocxData("financingRequestNumber", v)} placeholder="2025PTJEV000007" />
                                            <TextInput label="Data Cerere finantare" value={docxData.financingRequestDate} onChange={v => updateDocxData("financingRequestDate", v)} placeholder="04.08.2025" />
                                        </div>
                                    </CollapsibleSection>

                                    {/* Analiza actionariat */}
                                    <CollapsibleSection title="Analiza actionariat" icon="👥" isOpen={docxSectionsOpen.shareholders} onToggle={() => toggleDocxSection('shareholders')}>
                                        <DaNuToggle
                                            label="1. Exista persoane juridice asociate/actionare care creeaza o relatie de intreprindere partenera sau legata?"
                                            value={docxData.hasLegalPersonShareholders}
                                            onChange={v => updateDocxData("hasLegalPersonShareholders", v)}
                                            observation={docxData.observations.legalPerson}
                                            onObservationChange={v => updateObservation("legalPerson", v)}
                                        />
                                        <DaNuToggle
                                            label="1.1. Datele din Declaratia IMM sunt corect calculate?"
                                            value={docxData.isCalculationCorrect}
                                            onChange={v => updateDocxData("isCalculationCorrect", v)}
                                            observation={docxData.observations.calcCorrect}
                                            onObservationChange={v => updateObservation("calcCorrect", v)}
                                        />
                                        <DaNuToggle
                                            label="2. Exista persoane fizice care, prin participatii sau drepturi de vot, creeaza o relatie de parteneriat/legatura cu alta intreprindere?"
                                            value={docxData.hasNaturalPersonRelationships}
                                            onChange={v => updateDocxData("hasNaturalPersonRelationships", v)}
                                            observation={docxData.observations.naturalPerson}
                                            onObservationChange={v => updateObservation("naturalPerson", v)}
                                        />
                                        <DaNuToggle
                                            label="2.1. Datele privind legaturile prin persoane fizice sunt corect calculate?"
                                            value={docxData.isNaturalPersonCalculationCorrect}
                                            onChange={v => updateDocxData("isNaturalPersonCalculationCorrect", v)}
                                            observation={docxData.observations.naturalCalcCorrect}
                                            onObservationChange={v => updateObservation("naturalCalcCorrect", v)}
                                        />
                                    </CollapsibleSection>

                                    {/* Analiza guvernanta */}
                                    <CollapsibleSection title="Analiza guvernanta" icon="🏛" isOpen={docxSectionsOpen.governance} onToggle={() => toggleDocxSection('governance')}>
                                        <DaNuToggle
                                            label="2.1. Majoritatea membrilor organului de administrare sunt numiti/revocati de o alta intreprindere?"
                                            value={docxData.hasBoardMajorityAppointed}
                                            onChange={v => updateDocxData("hasBoardMajorityAppointed", v)}
                                            observation={docxData.observations.boardMajority}
                                            onObservationChange={v => updateObservation("boardMajority", v)}
                                        />
                                        <DaNuToggle
                                            label="2.2. Un actionar/asociat unic controleaza singur majoritatea drepturilor de vot?"
                                            value={docxData.hasSingleShareholderControl}
                                            onChange={v => updateDocxData("hasSingleShareholderControl", v)}
                                            observation={docxData.observations.shareholderControl}
                                            onObservationChange={v => updateObservation("shareholderControl", v)}
                                        />
                                    </CollapsibleSection>

                                    {/* Analiza dependenta piata */}
                                    <CollapsibleSection title="Analiza dependenta piata" icon="📊" isOpen={docxSectionsOpen.market} onToggle={() => toggleDocxSection('market')}>
                                        <DaNuToggle
                                            label="3.1. Exista un client cu pozitie dominanta (peste 50% din cifra de afaceri)?"
                                            value={docxData.hasDominantClient}
                                            onChange={v => updateDocxData("hasDominantClient", v)}
                                            observation={docxData.observations.dominantClient}
                                            onObservationChange={v => updateObservation("dominantClient", v)}
                                        />
                                        <DaNuToggle
                                            label="3.2. Exista un furnizor cu pozitie dominanta (peste 50% din costuri)?"
                                            value={docxData.hasDependentSupplier}
                                            onChange={v => updateDocxData("hasDependentSupplier", v)}
                                            observation={docxData.observations.dependentSupplier}
                                            onObservationChange={v => updateObservation("dependentSupplier", v)}
                                        />
                                    </CollapsibleSection>

                                    {/* Date evaluator */}
                                    <CollapsibleSection title="Date evaluator" icon="✍" isOpen={docxSectionsOpen.evaluator} onToggle={() => toggleDocxSection('evaluator')}>
                                        <div className="flex gap-3 flex-wrap">
                                            <TextInput label="Nume evaluator" value={docxData.evaluatorName} onChange={v => updateDocxData("evaluatorName", v)} placeholder="Nume Prenume" />
                                            <TextInput label="Data evaluarii" value={docxData.evaluationDate} onChange={v => updateDocxData("evaluationDate", v)} placeholder="2025-01-15" />
                                        </div>
                                    </CollapsibleSection>

                                    {/* Auto-filled preview */}
                                    <div className="mt-4 p-3 bg-cardAlt/50 rounded-lg border border-border/50">
                                        <div className="text-[10px] font-bold text-greenCustom/70 uppercase tracking-wider mb-2">Completate automat din analiza</div>
                                        <div className="flex flex-wrap gap-3 text-xs text-textDim">
                                            <span>Clasificare: <strong className="text-text">{classification === "autonomous" ? "Autonoma" : classification === "partner" ? "Partenera" : classification === "mixed" ? "Mixtă" : "Legata"}</strong></span>
                                            <span>|</span>
                                            <span>Incadrare: <strong className="text-text">{calculations.finalCategory}</strong></span>
                                            <span>|</span>
                                            <span>Solicitant: <strong className="text-text">{company.name || "—"}</strong></span>
                                            <span>|</span>
                                            <span>CUI: <strong className="text-text">{company.cui || "—"}</strong></span>
                                        </div>
                                    </div>

                                    {/* Download button */}
                                    <div className="mt-5 flex justify-end">
                                        <button onClick={downloadDocx} className="px-6 py-3 bg-greenCustom text-white font-bold rounded-xl flex items-center gap-2 hover:bg-green-600 transition-all shadow-lg shadow-greenCustom/20 group">
                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" /><polyline points="14 2 14 8 20 8" /></svg>
                                            Descarca Lista de Verificare (.docx)
                                            <span className="transform group-hover:translate-y-1 transition-transform">↓</span>
                                        </button>
                                    </div>
                                </Card>

                                <div className="flex justify-center pt-6 pb-12">
                                    <button onClick={() => location.reload()} className="flex items-center gap-2 p-3 text-sm font-semibold text-textDim hover:text-white transition-colors">
                                        ↺ Reia evaluarea
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // ─── App Wrapper with Auth Gate ───
        function App() {
            const { currentUser, loading, login, logout } = useAuth();
            const [showAdmin, setShowAdmin] = useState(false);

            if (loading) {
                return (
                    <div className="min-h-screen bg-bg flex items-center justify-center">
                        <div className="text-center">
                            <div className="w-8 h-8 border-2 border-accent border-t-transparent rounded-full animate-spin mx-auto mb-3"></div>
                            <p className="text-textDim text-sm">Se încarcă...</p>
                        </div>
                    </div>
                );
            }

            if (!currentUser) {
                return <LoginScreen onLogin={login} />;
            }

            if (showAdmin && currentUser.role === "admin") {
                return <AdminPanel currentUser={currentUser} onClose={() => setShowAdmin(false)} />;
            }

            return (
                <div>
                    {/* Auth Top Bar */}
                    <div className="bg-card border-b border-border px-4 py-2.5 flex items-center justify-between">
                        <div className="flex items-center gap-2.5 text-xs">
                            <div className={`w-7 h-7 rounded-full flex items-center justify-center text-[10px] font-bold ${currentUser.role === 'admin' ? 'bg-accentDim text-accent' : 'bg-blueDim text-blueCustom'}`}>
                                {currentUser.username.charAt(0).toUpperCase()}
                            </div>
                            <span className="text-textDim">{currentUser.username}</span>
                            <span className={`inline-block px-2 py-0.5 rounded-full text-[10px] font-bold uppercase tracking-wider ${currentUser.role === 'admin' ? 'bg-accentDim text-accent border border-accentBorder' : 'bg-blueDim text-blueCustom border border-blueBorder'}`}>
                                {currentUser.role === 'admin' ? 'Admin' : 'Utilizator'}
                            </span>
                        </div>
                        <div className="flex gap-2">
                            {currentUser.role === "admin" && (
                                <button onClick={() => setShowAdmin(true)}
                                    className="text-xs px-3 py-1.5 bg-accentDim border border-accentBorder text-accent rounded-lg hover:bg-accent/20 transition-colors font-medium">
                                    ⚙ Panou Admin
                                </button>
                            )}
                            <button onClick={logout}
                                className="text-xs px-3 py-1.5 bg-redDim border border-redBorder text-redCustom rounded-lg hover:bg-red-600/20 transition-colors font-medium">
                                Deconectare
                            </button>
                        </div>
                    </div>
                    {/* Main App */}
                    <IMMVerifier />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>